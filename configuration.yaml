# ============================================================================
# REID'S HOME ASSISTANT - COMPLETE CONFIGURATION
# Generated: 2026-01-08
# ============================================================================

homeassistant:
  name: Zuhause
  latitude: 49.91
  longitude: 9.08
  elevation: 150
  unit_system: metric
  time_zone: Europe/Berlin
  external_url: "https://reid15.duckdns.org"
  internal_url: "http://192.168.178.70:8123"
  packages:
    plant_growing: !include packages/plant_growing.yaml
    system_health: !include packages/system_health.yaml
    ai_generated: !include packages/ai_generated.yaml
    jarvis_agent: !include packages/jarvis_agent.yaml
    tp_link_fixes: !include packages/tp_link_fixes.yaml

# Mobile App - Required for Companion App functionality
mobile_app:

# Standard includes
automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml
input_boolean: !include input_boolean.yaml

# Lovelace Dashboards
lovelace:
  mode: yaml
  resources: [] # Clear resources
  dashboards:
    lovelace-home:
      mode: yaml
      title: Home Control
      icon: mdi:home-automation
      show_in_sidebar: true
      filename: dashboards/home_control.yaml
      require_admin: false
    lovelace-climate:
      mode: yaml
      title: Climate & Energy
      icon: mdi:leaf
      show_in_sidebar: true
      filename: dashboards/climate_energy.yaml
    lovelace-status:
      mode: yaml
      title: Automation Status
      icon: mdi:robot
      show_in_sidebar: true
      filename: dashboards/automation_status.yaml
    lovelace-plants:
      mode: yaml
      title: Plant Growing
      icon: mdi:sprout
      show_in_sidebar: true
      filename: dashboards/plant_growing.yaml

# ZHA Configuration
zha:
  enable_quirks: true
  custom_quirks_path: /config/custom_zha_quirks

# Logger
logger:
  default: warning
  logs:
    homeassistant.components.zha: debug
    zhaquirks: debug
    zigpy: debug

# Recorder - keeps DB small
recorder:
  purge_keep_days: 7
  commit_interval: 1
  auto_purge: true
  auto_repack: true
  exclude:
    domains:
      - automation
      - updater
      - camera
    entity_globs:
      - sensor.*_rssi
      - sensor.*_lqi
      - sensor.*_linkquality
    entities:
      - sun.sun
      - sensor.time
      - sensor.date

energy:
default_config:
bluetooth:

# HTTP configuration
# NOTE: SSL is commented out until DuckDNS add-on generates certificates
# Once /ssl/fullchain.pem exists, uncomment the ssl lines below
http:
  ssl_certificate: /ssl/fullchain.pem
  ssl_key: /ssl/privkey.pem
  use_x_forwarded_for: true
  trusted_proxies:
    - 0.0.0.0/0

# ============================================================================
# REST COMMANDS - Connection to n8n (AI Brain)
# ============================================================================
rest_command:
  n8n_grow_bot_check:
    url: "http://192.168.178.49:5678/webhook/grow-bot-check"
    method: POST
    payload: '{"temperature": {{ temperature }}, "humidity": {{ humidity }}, "stage": "{{ stage }}", "timestamp": "{{ timestamp }}"}'
    content_type: "application/json"

  n8n_cleaning_report:
    url: "http://192.168.178.49:5678/webhook/cleaning-report"
    method: POST
    payload: '{"start_time": "{{ start_time }}", "end_time": "{{ end_time }}", "hourly_rate": {{ hourly_rate }}}'
    content_type: "application/json"

  n8n_voice_notify:
    url: "http://192.168.178.49:5678/webhook/voice-notify"
    method: POST
    payload: '{"message": "{{ message }}", "voice_id": "{{ voice_id }}"}'
    content_type: "application/json"

  n8n_morning_briefing:
    url: "http://192.168.178.49:5678/webhook/morning-briefing"
    method: POST
    content_type: "application/json"

  n8n_cinema_mode:
    url: "http://192.168.178.49:5678/webhook/cinema-mode"
    method: POST
    payload: '{"mode": "on", "timestamp": "{{ now().isoformat() }}"}'
    content_type: "application/json"

# ============================================================================
# INPUT NUMBER - RolllÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¤den & Heizung
# ============================================================================
input_number:
  # Rollladen Position Tracking
  pos_wohnzimmer:
    name: "Rollladen Wohnzimmer Position"
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"
    mode: box
    icon: mdi:window-shutter
  pos_kuche:
    name: "Rollladen KÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¼che Position"
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"
    mode: box
    icon: mdi:window-shutter
  pos_kiffzimmer:
    name: "Rollladen Kiffzimmer Position"
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"
    mode: box
    icon: mdi:window-shutter
  pos_schlafzimmer:
    name: "Rollladen Schlafzimmer Position"
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "%"
    mode: box
    icon: mdi:window-shutter

  # Heizung Sollwerte
  heizung_solltemperatur_komfort:
    name: "Heizung Komfort-Temperatur"
    min: 18
    max: 25
    step: 0.5
    initial: 23
    unit_of_measurement: "ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â°C"
    mode: slider
    icon: mdi:thermometer
  heizung_solltemperatur_eco:
    name: "Heizung Eco-Temperatur"
    min: 16
    max: 20
    step: 0.5
    initial: 18
    unit_of_measurement: "ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â°C"
    mode: slider
    icon: mdi:thermometer-low
  heizung_solltemperatur_nacht:
    name: "Heizung Nacht-Temperatur"
    min: 15
    max: 19
    step: 0.5
    initial: 17
    unit_of_measurement: "ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â°C"
    mode: slider
    icon: mdi:thermometer-low

  # Motion Timeout
  motion_timeout:
    name: "Bewegungsmelder Timeout"
    min: 30
    max: 600
    step: 30
    initial: 120
    unit_of_measurement: "sec"
    mode: slider
    icon: mdi:timer

  # Flux (Adaptive Lighting)
  flux_kelvin:
    name: "Flux Target Kelvin"
    min: 2000
    max: 6500
    initial: 2700
    step: 100
    mode: box
    icon: mdi:thermometer-lines

  flux_brightness:
    name: "Flux Target Brightness"
    min: 1
    max: 100
    initial: 80
    step: 1
    mode: box
    icon: mdi:brightness-6

# ============================================================================
# INPUT SELECT - Szenen & Modi
# ============================================================================
input_select:
  ambient_modus:
    name: "Ambient Modus"
    options:
      - "Aus"
      - "Warm Flicker"
      - "Velvet Rainbow"
      - "Entspannt"
      - "Fokus"
    initial: "Aus"
    icon: mdi:palette

  home_mode:
    name: "Zuhause Modus"
    options:
      - "Normal"
      - "Arbeit"
      - "Entspannen"
      - "Schlafen"
      - "GÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¤ste"
      - "Urlaub"
    initial: "Normal"
    icon: mdi:home-assistant

# ============================================================================
# TEMPLATE - Modern Syntax
# ============================================================================
template:
  - sensor:
      - name: "Aktuelle Jahreszeit"
        unique_id: aktuelle_jahreszeit
        state: >
          {% set month = now().month %}
          {% if month in [3, 4, 5] %}
            FrÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¼hling
          {% elif month in [6, 7, 8] %}
            Sommer
          {% elif month in [9, 10, 11] %}
            Herbst
          {% else %}
            Winter
          {% endif %}
        icon: >
          {% set month = now().month %}
          {% if month in [3, 4, 5] %}
            mdi:flower
          {% elif month in [6, 7, 8] %}
            mdi:white-balance-sunny
          {% elif month in [9, 10, 11] %}
            mdi:leaf
          {% else %}
            mdi:snowflake
          {% endif %}

      - name: "Rollladen Sonnenuntergang Offset"
        unique_id: rollladen_offset_minuten
        unit_of_measurement: "min"
        state: >
          {% set month = now().month %}
          {% if month in [5, 6, 7, 8, 9] %}
            120
          {% elif month in [3, 4, 10] %}
            60
          {% else %}
            0
          {% endif %}

  - binary_sensor:
      - name: "Sommerbetrieb (AuÃƒÆ’Ã†â€™Ãƒâ€¦Ã‚Â¸entemperatur)"
        unique_id: sommerbetrieb_ortsbasiert
        state: "{{ state_attr('weather.forecast_home', 'temperature')|float(0) > 18 }}"
        icon: >
          {% if state_attr('weather.forecast_home', 'temperature')|float(0) > 18 %}
            mdi:weather-sunny
          {% else %}
            mdi:snowflake
          {% endif %}

      - name: "Jemand Zuhause"
        unique_id: jemand_zuhause
        state: >
          {{ is_state('binary_sensor.wohnzimmer_wohnzimmer_presence_sensor_fp2_presence_sensor_fp2_f9cf_presence_sensor_1', 'on') or
             is_state('binary_sensor.kuche_kueche_motion_sensor', 'on') or
             is_state('binary_sensor.badezimmer_badezimmer_motion_sensor', 'on') or
             is_state('binary_sensor.schlafzimmer_schlafzimmer_presence_sensor_bewegung', 'on') }}
        icon: >
          {% if is_state('binary_sensor.jemand_zuhause', 'on') %}
            mdi:home-account
          {% else %}
            mdi:home-outline
          {% endif %}

      - name: "Heizperiode aktiv"
        unique_id: heizperiode
        state: "{{ now().month in [1, 2, 3, 4, 10, 11, 12] }}"
        icon: mdi:radiator

      - name: "Dunkel draußen"
        unique_id: dunkel_draussen
        state: "{{ is_state('sun.sun', 'below_horizon') }}"
        icon: mdi:weather-night

      # Skill: Advanced Presence Detection
      - name: "Wohnzimmer Presence Sensor"
        unique_id: wohnzimmer_presence_sensor
        delay_off: "00:01:00" # 1 min buffer
        state: >
          {{ 
             is_state('binary_sensor.wohnzimmer_wohnzimmer_presence_sensor_fp2_presence_sensor_fp2_f9cf_presence_sensor_1', 'on')
             # or is_state('media_player.living_room_tv', 'playing') # Uncomment when TV is integrated
          }}
        icon: mdi:account-eye

      - name: "Küche Presence Sensor"
        unique_id: kuche_presence_sensor
        delay_off: "00:01:30" # 90s buffer for cooking
        state: >
          {{ 
             is_state('binary_sensor.kuche_kueche_motion_sensor', 'on')
             or is_state('binary_sensor.kuche_kueche_presence_sensor_bewegung', 'on')
          }}
        icon: mdi:chef-hat

      - name: "Badezimmer Presence Sensor"
        unique_id: badezimmer_presence_sensor
        delay_off: "00:02:00" # 2 min buffer (showering/brushing teeth)
        state: >
          {{ 
             is_state('binary_sensor.badezimmer_badezimmer_motion_sensor', 'on')
             or is_state('binary_sensor.badezimmer_badezimmer_presence_sensor_bewegung', 'on')
          }}
        icon: mdi:shower

      - name: "Schlafzimmer Presence Sensor"
        unique_id: schlafzimmer_presence_sensor
        delay_off: "00:00:30" # Short buffer
        state: >
          {{ 
             is_state('binary_sensor.schlafzimmer_schlafzimmer_presence_sensor_bewegung', 'on')
             or is_state('binary_sensor.schlafzimmer_schlafzimmer_tuersensor_opening', 'on')
          }}
        icon: mdi:bed

      - name: "Kiffzimmer Presence Sensor"
        unique_id: kiffzimmer_presence_sensor
        delay_off: "00:01:00" # 1 min buffer
        state: >
          {{ 
             is_state('binary_sensor.kiffzimmer_kiffzimmer_motion_sensor', 'on')
          }}
        icon: mdi:cannabis

# ============================================================================
# ============================================================================
# BINARY SENSOR - Templates (migrated to template:)
# ============================================================================

# ============================================================================
# NOTIFY - Groups
# ============================================================================
notify:
  - platform: group
    name: alle_geraete
    services:
      - service: mobile_app_redmi_note_12_pro_5g

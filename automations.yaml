- id: roller_pc_anti_glare
  alias: Rollladen Computer â€“ Anti-Glare (FP2 + Sonne + Lux)
  mode: restart
  trigger:
    # State-based triggers - instant reaction
    - platform: state
      entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence
    - platform: numeric_state
      entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level
      above: 600
      for:
        minutes: 2
    - platform: numeric_state
      entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level
      below: 10
      for:
        minutes: 5
    # Sun position changes
    - platform: state
      entity_id: sun.sun
      attribute: azimuth
    # Backup polling - reduced from /5 to /30 for performance
    - platform: time_pattern
      minutes: "/30"
  variables:
    sun_ok: "{{ (state_attr('sun.sun','azimuth')|float(0) >= 120) and\n   (state_attr('sun.sun','azimuth')|float(0)
      <= 240) and\n   (state_attr('sun.sun','elevation')|float(0) > 10) }}"
    lux: '{{ states(''sensor.presence_sensor_fp2_f9cf_light_sensor_light_level'')|int(0)
      }}'
    present: '{{ is_state(''binary_sensor.presence_sensor_fp2_f9cf_presence'',''on'')
      }}'
    t_out: '{{ states(''sensor.openweathermap_temperature'')|float(0) }}'
  action:
  - choose:
    # Blendschutz: 10% Position = 2 Sekunden
    - conditions:
      - condition: template
        value_template: '{{ present and sun_ok and lux >= 600 }}'
      - condition: time
        after: 08:00:00
        before: '19:30:00'
      sequence:
      - service: cover.open_cover
        target:
          entity_id: cover.rollladen_computer_vorhang
      - delay:
          seconds: 2
      - service: cover.stop_cover
        target:
          entity_id: cover.rollladen_computer_vorhang
    # Teilweise offen bei warmem Wetter: 85% = 18 Sekunden
    - conditions:
      - condition: time
        after: 08:00:00
        before: '19:30:00'
      - condition: numeric_state
        entity_id: sensor.openweathermap_temperature
        above: 20
      sequence:
      - service: cover.open_cover
        target:
          entity_id: cover.rollladen_computer_vorhang
      - delay:
          seconds: 18
      - service: cover.stop_cover
        target:
          entity_id: cover.rollladen_computer_vorhang
    # Komplett Ã¶ffnen (Standard)
    - conditions:
      - condition: time
        after: 08:00:00
        before: '19:30:00'
      sequence:
      - service: cover.open_cover
        target:
          entity_id: cover.rollladen_computer_vorhang
- id: rollers_heat_protect_south
  alias: Rollladen SÃ¼d â€“ Hitzeschutz tagsÃ¼ber (KÃ¼che & Yoga)
  mode: restart
  trigger:
    # Lux-based triggers
    - platform: numeric_state
      entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level
      above: 600
      for:
        minutes: 3
    - platform: numeric_state
      entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level
      below: 10
      for:
        minutes: 10
    # Sun position changes
    - platform: state
      entity_id: sun.sun
      attribute: azimuth
    - platform: state
      entity_id: sun.sun
      attribute: elevation
    # Summer mode state changes
    - platform: state
      entity_id: binary_sensor.sommerbetrieb_ortsbasiert
    # Backup polling - reduced from /7 to /30 for performance
    - platform: time_pattern
      minutes: "/30"
  condition:
  - condition: time
    after: 09:00:00
    before: '18:30:00'
  - condition: state
    entity_id: binary_sensor.sommerbetrieb_ortsbasiert
    state: 'on'
  variables:
    sun_ok: "{{ (state_attr('sun.sun','azimuth')|float(0) >= 120) and\n   (state_attr('sun.sun','azimuth')|float(0)
      <= 240) and\n   (state_attr('sun.sun','elevation')|float(0) > 10) }}"
  action:
  - choose:
    # Hitzeschutz: 15% Position = 3 Sekunden
    - conditions:
      - condition: template
        value_template: '{{ sun_ok }}'
      - condition: numeric_state
        entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level
        above: 600
      sequence:
      # KÃ¼che Hitzeschutz
      - service: cover.open_cover
        target:
          entity_id: cover.kuche_blind_vorhang
      - delay:
          seconds: 3
      - service: cover.stop_cover
        target:
          entity_id: cover.kuche_blind_vorhang
      # Yoga Hitzeschutz
      - service: cover.open_cover
        target:
          entity_id: cover.yoga_blind_vorhang
      - delay:
          seconds: 3
      - service: cover.stop_cover
        target:
          entity_id: cover.yoga_blind_vorhang
    # Komplett Ã¶ffnen (Standard)
    default:
    - service: cover.open_cover
      target:
        entity_id:
          - cover.kuche_blind_vorhang
          - cover.yoga_blind_vorhang
- id: rollers_evening_flush_south
  alias: Rollladen SÃ¼d â€“ Abendliche Frischluft (KÃ¼che, Yoga, Computer)
  mode: single
  variables:
    wind_ok: '{{ states(''sensor.openweathermap_wind_speed'')|float(99) < 8 }}'
    temp_ok: '{{ states(''sensor.openweathermap_temperature'')|float(99) <= 23 }}'
    rh_ok: '{{ states(''sensor.openweathermap_humidity'')|float(0) <= 85 }}'
    dp_ok: '{{ states(''sensor.outdoor_dewpoint'')|float(99) <= 16 }}'
  trigger:
  - platform: time
    at: '18:00:00'
    id: start
  - platform: time
    at: '23:30:00'
    id: end
  condition:
  - condition: state
    entity_id: binary_sensor.sommerbetrieb_ortsbasiert
    state: 'on'
  action:
  - choose:
    # LÃ¼ften: 85% Position = 18 Sekunden
    - conditions:
      - condition: trigger
        id: start
      sequence:
      - condition: template
        value_template: '{{ wind_ok and temp_ok and rh_ok and dp_ok }}'
      # KÃ¼che LÃ¼ften
      - service: cover.open_cover
        target:
          entity_id: cover.kuche_blind_vorhang
      - delay:
          seconds: 18
      - service: cover.stop_cover
        target:
          entity_id: cover.kuche_blind_vorhang
      # Yoga LÃ¼ften
      - service: cover.open_cover
        target:
          entity_id: cover.yoga_blind_vorhang
      - delay:
          seconds: 18
      - service: cover.stop_cover
        target:
          entity_id: cover.yoga_blind_vorhang
      # Computer LÃ¼ften
      - service: cover.open_cover
        target:
          entity_id: cover.rollladen_computer_vorhang
      - delay:
          seconds: 18
      - service: cover.stop_cover
        target:
          entity_id: cover.rollladen_computer_vorhang
    # Komplett Ã¶ffnen (Standard bei 23:30)
    default:
    - service: cover.open_cover
      target:
        entity_id:
          - cover.kuche_blind_vorhang
          - cover.yoga_blind_vorhang
          - cover.rollladen_computer_vorhang
- id: schlafen_vorlueften_2100
  alias: Schlafen â€“ Vor-LÃ¼ften 21:00 (inkl. Ventilator Winter/Low)
  mode: single
  trigger:
  - platform: time
    at: '21:00:00'
  action:
  # LÃ¼ften: 85% Position = 18 Sekunden
  - service: cover.open_cover
    target:
      entity_id: cover.schlafen_blind_vorhang
  - delay:
      seconds: 18
  - service: cover.stop_cover
    target:
      entity_id: cover.schlafen_blind_vorhang
  - service: script.turn_on
    target:
      entity_id: script.ventilator_wintermodus_low
- id: schlafen_werk_close_0455
  alias: Schlafen â€“ Werktags 04:55 schlieÃŸen
  mode: single
  triggers:
    - platform: time
      at: '04:55:00'
  conditions:
    - condition: time
      weekday: [mon, tue, wed, thu, fri]
  actions:
    - service: cover.close_cover
      target:
        entity_id: cover.schlafen_blind_vorhang
      continue_on_error: true
    # Close additional cover (device e21cdce801f7b99185001e7544b1c32a)
    - service: cover.close_cover
      target:
        entity_id: cover.ea01332b291ecc7d381e59df51600bd0  # TODO: Replace with readable name
      continue_on_error: true
- id: schlafen_weekend_open_1000
  alias: Schlafen â€“ Wochenende 10:00 Ã¶ffnen
  mode: single
  triggers:
    - platform: time
      at: '10:00:00'
  conditions:
    - condition: time
      weekday: [sat, sun]
  actions:
    - service: cover.open_cover
      target:
        entity_id: cover.schlafen_blind_vorhang
      continue_on_error: true
    # Close additional cover (device e21cdce801f7b99185001e7544b1c32a)
    - service: cover.close_cover
      target:
        entity_id: cover.ea01332b291ecc7d381e59df51600bd0  # TODO: Replace with readable name
      continue_on_error: true
- id: '1756663066410'
  alias: Licht an 15lx - Low Light Ambient
  description: 'Turn on ambient lights when illuminance drops below 15 lux'
  mode: single
  triggers:
    # Lux-based trigger (FP2 sensor)
    - platform: numeric_state
      entity_id: sensor.fp2_light_level  # Using template sensor
      below: 15
      for:
        minutes: 10
    # Backup time-based check
    - platform: time_pattern
      minutes: '30'
  conditions:
    # Only if sensor is available and really dark
    - condition: numeric_state
      entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level
      below: 15
  actions:
    # Turn on all ambient lights at once
    - service: light.turn_on
      target:
        entity_id:
          - light.ambient_light_1  # Device: 8c0861d5de0795e1492a8eaeea69c72a / 1368fea07848a80d288c0aff0af3cf1c
          - light.ambient_light_2  # Device: dff6231b45ad4abd9fec55f83af21d78 / e1a3c27842ab023629bd0c3d766dc5fc
          - light.ambient_light_3  # Device: ceb5bc29b2669f8871ae800bca1807a7 / a5ec8243261c2ded541e37e7638fa2b7
      continue_on_error: true

    # Apply fire flicker effect to all lights that turned on successfully
    - delay:
        seconds: 2
    - service: script.ambient_feuerlicht_warm_flicker
      continue_on_error: true
- id: '1756663264657'
  alias: Heizung Aus Fenster offen - Energy Saving
  description: 'Turn off heating when windows/doors are opened'
  mode: restart  # Allow restart to handle multiple openings
  trigger:
    # Window/Door sensor 1
    - platform: state
      entity_id: binary_sensor.door_sensor_1  # Device: 1d8ac79daf016e689bf40f1499f28678 / 6ae39821a45e76cf38ec0e5459333954
      to: 'on'
      for:
        seconds: 30  # Debounce: Wait 30s to avoid false triggers
    # Window/Door sensor 2
    - platform: state
      entity_id: binary_sensor.door_sensor_2  # Device: 5c463b96e0e706e7e78d06703972e0ee / 4ab0a1216721d7ee3491dd890a83ace7
      to: 'on'
      for:
        seconds: 30
  condition: []
  action:
    # Turn off all thermostats
    - service: climate.set_hvac_mode
      target:
        entity_id:
          - climate.thermostat_bad      # Device: 8cec1333229554f7f822ace0168e4191 / 646e41b75dc2d7a8f1d0285ca94e1ac5
          - climate.thermostat_computer  # Device: 9402ef88977fa51cf9fc7e4c5383d2cc / 465b11050fd6118181722cc97f5b8183
      data:
        hvac_mode: 'off'
      continue_on_error: true

    # Log action
    - service: system_log.write
      data:
        message: "Heating turned off due to open window/door"
        level: info
      continue_on_error: true
- id: '1756747296174'
  alias: Schlafen Arbeit Bettgehlicht - Optimiert
  description: Optimierte Version mit Entity-Triggern
  triggers:
  - type: motion
    device_id: aebec0c58872e00fe8fa89b0a846a29e
    entity_id: 58a470e22a792e2f2d7a2e13233b3d50
    domain: binary_sensor
    trigger: device
  conditions:
  - condition: time
    after: '21:00:00'
    before: '23:59:59'
    weekday:
    - mon
    - tue
    - wed
    - thu
    - sun
  - condition: state
    entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_2
    state: 'off'
  
  - target:
      entity_id:
      - light.ceiling_fan_light
      - light.bed_light
      - light.bett_licht
      - light.dc_fan_lamp
      - light.bett_lichtstreifen
      - light.kleiderschrank
    data:
      brightness_pct: 100
    action: light.turn_on
  - wait_for_trigger:
    - entity_id: binary_sensor.motion_sensor_bad
      to: 'off'
      for:
        minutes: 2
      trigger: state
    timeout: 00:30:00
  - target:
      entity_id:
      - light.ceiling_fan_light
      - light.bed_light
      - light.bett_licht
      - light.dc_fan_lamp
      - light.bett_lichtstreifen
      - light.kleiderschrank
    action: light.turn_off
    data: {}
  - target:
      entity_id:
      - fan.ceiling_fan
      - fan.ceiling_fan_with_light
    action: fan.turn_off
    data: {}
  mode: restart
  max_exceeded: silent
- id: '1756747597052'
  alias: Schlafen gehen Arbeit Licht aus
  triggers:
  - type: turned_on
    device_id: bc3db6d06da6b18298a1755b4788e7e6
    entity_id: ad882cbbc0c0222e4b99e39f646e26dc
    domain: binary_sensor
    trigger: device
  conditions:
  - condition: time
    after: '21:00:00'
    before: '23:59:59'
    weekday:
    - mon
    - tue
    - wed
    - thu
    - sun
  - type: is_not_occupied
    condition: device
    device_id: 2ce83ab1b7ba9e3161a4584846503d5b
    entity_id: 10610e701b173fd96fe8f66dcb695b1d
    domain: binary_sensor
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.sommerbetrieb_ortsbasiert
        state: 'on'
      sequence:
      - target:
          entity_id: script.ventilator_wintermodus_low
        action: script.turn_on
        data: {}
  - data:
      transition: 2
    action: light.turn_off
    target:
      entity_id:
      - light.bad_2
      - light.bad_licht
      - light.bett_licht
      - light.kleiderschrank
      - light.ceiling_fan_light
      - light.bed_light
      - light.bett_licht
      - light.dc_fan_lamp
      - light.bett_lichtstreifen

      device_id: 24856663a72fdc78cbfa8ab36c4765d1
  - wait_for_trigger:
    - entity_id:
      - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_2
      to: 'off'
      trigger: state
    timeout: 00:01:00
    continue_on_timeout: true
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ wait.trigger is none }}'
      sequence:
      - target:
          entity_id:
          - fan.a14baab7198c0de3311dbee8b11fedab
          - fan.ceiling_fan_with_light
        action: fan.turn_off
        data: {}
  mode: restart
- id: '1756751836548'
  alias: Aufstehen Arbeit ANaus
  mode: single
  trigger:
  - platform: device
    type: motion
    device_id: aebec0c58872e00fe8fa89b0a846a29e
    entity_id: 58a470e22a792e2f2d7a2e13233b3d50
    domain: binary_sensor
  - platform: device
    type: not_occupied
    device_id: 2ce83ab1b7ba9e3161a4584846503d5b
    entity_id: 0cdd8c719f32cb3da3cceac4a7235bb0
    domain: binary_sensor
    for:
      minutes: 5
  condition:
  - condition: time
    after: 05:30:00
    before: '11:59:59'
    weekday:
    - mon
    - tue
    - wed
    - thu
    - sun
  action:
  - type: turn_off
    device_id: 3586709559e4e46394dfa54ebf906373
    entity_id: a14baab7198c0de3311dbee8b11fedab
    domain: fan
  - type: turn_off
    device_id: 3586709559e4e46394dfa54ebf906373
    entity_id: fdda598413ef1d0f54a4b1efa3956174
    domain: light
  - type: turn_off
    device_id: 09da8d97be4777a9a94cc9b8e53d68c4
    entity_id: bc0d3fd25e385f3c1056ed9ead8aa858
    domain: light
    brightness_pct: 100
  - type: turn_off
    device_id: 8c0861d5de0795e1492a8eaeea69c72a
    entity_id: 1368fea07848a80d288c0aff0af3cf1c
    domain: light
  - type: turn_off
    device_id: 47e2b96815418006d76b8d1e977ba055
    entity_id: 08a15d443a7bdfa3df511ddcfc90d9fd
    domain: light
  - type: turn_off
    device_id: 05bc8157f6969d1a009e9ccedd2c202e
    entity_id: dfc09e5a381dc9c8f135d08d9e4c917b
    domain: light
  - type: turn_off
    device_id: 11599d23c3dbab6de01f8403fed0566e
    entity_id: 14dae7d0e2ddfac00118a921d07d915e
    domain: light
  - type: turn_off
    device_id: d838bde16b7234c16471507cd1cb27be
    entity_id: 16b31f92de912e3c8cbca2876e3b1c1f
    domain: light

- id: bett_licht_aus_no_motion_20s
  alias: Bett â€“ Licht aus nach 20s ohne Bewegung
  triggers:
  - type: turned_off
    device_id: bc3db6d06da6b18298a1755b4788e7e6
    entity_id: ad882cbbc0c0222e4b99e39f646e26dc
    domain: binary_sensor
    trigger: device
    for:
      hours: 0
      minutes: 0
      seconds: 20
  conditions:
  - type: is_not_occupied
    condition: device
    device_id: 2ce83ab1b7ba9e3161a4584846503d5b
    entity_id: 10610e701b173fd96fe8f66dcb695b1d
    domain: binary_sensor
    for:
      hours: 0
      minutes: 0
      seconds: 20
  actions:
    # Turn off all lights
    - service: light.turn_off
      target:
        entity_id:
          - light.bed_light  # bc0d3fd25e385f3c1056ed9ead8aa858
          - light.bett_licht  # 7fff5f0e94d27ad73e640bb60c73d314
          - light.ambient_light_1  # a5ec8243261c2ded541e37e7638fa2b7
          - light.ambient_light_2  # e1a3c27842ab023629bd0c3d766dc5fc
          - light.ambient_light_3  # f7aae072f642bae85c9a5b4faafb127a
          - light.kuche_licht  # dc2d1b19833aaac2ea089fe8a751574f
      continue_on_error: true

    # Turn off all fans (removed duplicates!)
    - service: fan.turn_off
      target:
        entity_id:
          - fan.ceiling_fan  # 188204738533536bc636218e65a74b53
          - fan.ceiling_fan_with_light  # a14baab7198c0de3311dbee8b11fedab
      continue_on_error: true
  mode: restart
- id: '1757962675739'
  alias: Licht aus KÃ¼che
  description: Schaltet das Licht aus, wenn FP2 sensor anwesenheit hat
  triggers:
  - type: no_motion
    device_id: c29865854655cf19cc904091dfa49ab0
    entity_id: 908b875fe48a1487586614292dd351de
    domain: binary_sensor
    trigger: device
    for:
      hours: 0
      minutes: 1
      seconds: 0
  - type: occupied
    device_id: 2ce83ab1b7ba9e3161a4584846503d5b
    entity_id: 10610e701b173fd96fe8f66dcb695b1d
    domain: binary_sensor
    trigger: device
  conditions: []
  actions:
  - type: turn_off
    device_id: db2f7007d9ab40883ebc98eba9815384
    entity_id: dc2d1b19833aaac2ea089fe8a751574f
    domain: light
  - type: turn_off
    device_id: 274a4e3fba305eef548db23296690d2d
    entity_id: 708363eeb019712e16145550302148ef
    domain: light
  - type: turn_off
    device_id: 3eb1ab346e4917536b2108c5aa33c616
    entity_id: f7aae072f642bae85c9a5b4faafb127a
    domain: light
  mode: single
- id: wecker_lichtrampe_werktage_unified
  alias: Schlafzimmer â€“ Wecker-Lichtrampe (Moâ€“Fr 04:30â†’05:00)
  description: Intelligente Lichtrampe - nutzt native Transition wenn unterstÃ¼tzt, sonst emuliert
  mode: single
  variables:
    ramp_seconds: 1800
    steps: 100
    step_delay: '{{ (ramp_seconds / steps) | int }}'
  trigger:
    - platform: time
      at: '04:30:00'
  condition:
    - condition: time
      weekday: [mon, tue, wed, thu, fri]
  action:
    # Try native transition first
    - choose:
        # Check if light supports transition (feature bit 32)
        - conditions:
            - condition: template
              value_template: >
                {{ state_attr('light.schlafzimmer_licht', 'supported_features') is not none
                   and state_attr('light.schlafzimmer_licht', 'supported_features')|int(0)|bitwise_and(32) > 0 }}
          sequence:
            # Native transition support - use it!
            - service: light.turn_on
              target:
                entity_id: light.schlafzimmer_licht
              data:
                brightness_pct: 1
            - service: light.turn_on
              target:
                entity_id: light.schlafzimmer_licht
              data:
                brightness_pct: 100
                transition: 1800
      default:
        # Fallback: Emulated transition
        - service: light.turn_on
          target:
            entity_id: light.schlafzimmer_licht
          data:
            brightness_pct: 1
        - repeat:
            count: '{{ steps }}'
            sequence:
              - service: light.turn_on
                target:
                  entity_id: light.schlafzimmer_licht
                data:
                  brightness_step_pct: 1
              - delay:
                  seconds: '{{ step_delay }}'
- id: roller_pc_lueften_warm_keine_sonne
  alias: Rollladen Computer â€“ LÃ¼ften bei >20Â°C (ohne Sonne)
  triggers:
    # Temperature-based trigger
    - platform: numeric_state
      entity_id: sensor.openweathermap_temperature
      above: 20
    # Lux-based trigger
    - platform: numeric_state
      entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level
      below: 400
      for:
        minutes: 5
    # Backup polling - reduced from /5 to /30
    - platform: time_pattern
      minutes: "/30"
  conditions:
  - condition: time
    after: '10:00:00'
    before: '18:00:00'
  - condition: numeric_state
    entity_id: sensor.openweathermap_temperature
    above: 20
  - condition: numeric_state
    entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level
    below: 400
  actions:
  - service: cover.open_cover
    target:
      entity_id: cover.rollladen_computer_vorhang
  mode: restart
- id: nachtmodus_dimme_lichter
  alias: Nachtmodus â€“ Neue Lichter auf 15 % dimmen (23:30â€“05:00)
  triggers:
  - entity_id:
    - light.schlafzimmer_licht
    - light.ceiling_fan_light
    - light.bed_light
    to: 'on'
    trigger: state
  conditions:
  - condition: time
    after: '23:30:00'
    before: 05:00:00
  actions:
  - data:
      brightness_pct: 15
      transition: 3
    action: light.turn_on
    target:
      entity_id:
      - light.schlafzimmer_licht
      - light.ceiling_fan_light
      - light.bed_light
      area_id: schlafzimmer
      label_id: schlafzimmer
  mode: restart
- id: '1758052166199'
  alias: Schlafen Licht aus ohne Wecker
  description: ''
  triggers:
  - type: turned_off
    device_id: bc3db6d06da6b18298a1755b4788e7e6
    entity_id: ad882cbbc0c0222e4b99e39f646e26dc
    domain: binary_sensor
    trigger: device
    for:
      hours: 0
      minutes: 0
      seconds: 20
  conditions:
    # Fixed: Split impossible time condition into OR (evening OR night/early morning)
    - condition: or
      conditions:
        - condition: time
          after: '06:30:00'
          before: '23:59:59'
        - condition: time
          after: '00:00:00'
          before: '04:30:00'
  actions:
  - type: turn_off
    device_id: 09da8d97be4777a9a94cc9b8e53d68c4
    entity_id: bc0d3fd25e385f3c1056ed9ead8aa858
    domain: light
  - type: turn_off
    device_id: 054f3b654c081cacaf8e2610359d7229
    entity_id: 638f7a53c21a6aeebbbe4c70bb9fa1df
    domain: light
  - type: turn_off
    device_id: c1f198570580668ee450aee43a80d863
    entity_id: 59e76beba475ff7bed49de05fc211e8a
    domain: light
  - type: turn_off
    device_id: 24856663a72fdc78cbfa8ab36c4765d1
    entity_id: 7fff5f0e94d27ad73e640bb60c73d314
    domain: light
  - type: turn_off
    device_id: 76361dfbed405867437d4b94a3995bb6
    entity_id: 188204738533536bc636218e65a74b53
    domain: fan
  - type: turn_off
    device_id: 76361dfbed405867437d4b94a3995bb6
    entity_id: c89deabc4968aea0ddb6510f196c0c0b
    domain: light
  mode: single
- id: '1758083317550'
  alias: 'Schlafen Licht aus '
  description: ''
  triggers:
  - type: turned_off
    device_id: bc3db6d06da6b18298a1755b4788e7e6
    entity_id: ad882cbbc0c0222e4b99e39f646e26dc
    domain: binary_sensor
    trigger: device
    for:
      hours: 0
      minutes: 1
      seconds: 0
  conditions: []
  actions:
  - type: turn_off
    device_id: 09da8d97be4777a9a94cc9b8e53d68c4
    entity_id: bc0d3fd25e385f3c1056ed9ead8aa858
    domain: light
  mode: single
- id: '1758128792497'
  alias: Bad Licht an
  description: 'Mit Debouncing fÃ¼r stabile Erkennung'
  mode: restart  # Allow restart to handle rapid state changes
  triggers:
    - platform: state
      entity_id: binary_sensor.motion_sensor_bad
      to: 'on'
      for:
        seconds: 2  # Debounce flicker
  conditions:
    # Don't turn on if already on and was on recently
    - condition: state
      entity_id: light.bad_licht
      state: 'off'
      for:
        seconds: 5  # Prevent rapid on/off cycles
  actions:
    - service: light.turn_on
      target:
        entity_id: light.bad_licht
      continue_on_error: true
- id: '1758128839131'
  alias: Bad aus
  description: ''
  triggers:
  - type: no_motion
    device_id: aebec0c58872e00fe8fa89b0a846a29e
    entity_id: 58a470e22a792e2f2d7a2e13233b3d50
    domain: binary_sensor
    trigger: device
    for:
      hours: 0
      minutes: 2
      seconds: 0
  conditions: []
  actions:
  - type: turn_off
    device_id: ffd6ad3612028069ca89a7fa557bf0e4
    entity_id: e01337629e974472db8c867288cc1c20
    domain: light
  mode: single
- id: '1758137148626'
  alias: Wohnzimmer Licht an Nach Sonnenuntergang
  description: ''
  triggers:
  - type: occupied
    device_id: 2ce83ab1b7ba9e3161a4584846503d5b
    entity_id: 10610e701b173fd96fe8f66dcb695b1d
    domain: binary_sensor
    trigger: device
  conditions:
  - condition: sun
    before: sunrise
    after: sunset
  actions:
  - type: turn_off
    device_id: 8c0861d5de0795e1492a8eaeea69c72a
    entity_id: 1368fea07848a80d288c0aff0af3cf1c
    domain: light
  - choose:
    - conditions:
      - condition: device
        type: is_on
        device_id: 8c0861d5de0795e1492a8eaeea69c72a
        entity_id: 1368fea07848a80d288c0aff0af3cf1c
        domain: light
      sequence:
      - action: script.ambient_feuerlicht_warm_flicker
        metadata: {}
        data: {}
  - type: turn_on
    device_id: ceb5bc29b2669f8871ae800bca1807a7
    entity_id: a5ec8243261c2ded541e37e7638fa2b7
    domain: light
  - choose:
    - conditions:
      - condition: device
        type: is_on
        device_id: 47e2b96815418006d76b8d1e977ba055
        entity_id: 08a15d443a7bdfa3df511ddcfc90d9fd
        domain: light
      sequence:
      - action: script.ambient_feuerlicht_warm_flicker
        metadata: {}
        data: {}
  - type: turn_on
    device_id: 2ce65532afcdf33a948b25a5d5d920a0
    entity_id: d47e3ee3b53eb993b0191b02b586289b
    domain: switch
  mode: single
- id: '1758304543368'
  alias: Wohnzimmer - Abend Licht an
  description: ''
  triggers:
  - type: occupied
    device_id: 2ce83ab1b7ba9e3161a4584846503d5b
    entity_id: 10610e701b173fd96fe8f66dcb695b1d
    domain: binary_sensor
    trigger: device
  conditions:
  - condition: sun
    before: sunrise
    after: sunset
  actions:
  - type: turn_on
    device_id: dff6231b45ad4abd9fec55f83af21d78
    entity_id: e1a3c27842ab023629bd0c3d766dc5fc
    domain: light
  - type: turn_off
    device_id: ceb5bc29b2669f8871ae800bca1807a7
    entity_id: a5ec8243261c2ded541e37e7638fa2b7
    domain: light
  mode: single
- id: '1758396085814'
  alias: KÃ¼che Licht ein
  description: ''
  triggers:
  - type: occupied
    device_id: 2ce83ab1b7ba9e3161a4584846503d5b
    entity_id: 4015d6e6f31ac6889216799c4b364e1c
    domain: binary_sensor
    trigger: device
  conditions: []
  actions:
  - type: turn_on
    device_id: 274a4e3fba305eef548db23296690d2d
    entity_id: 708363eeb019712e16145550302148ef
    domain: light
  - type: turn_on
    device_id: 274a4e3fba305eef548db23296690d2d
    entity_id: 708363eeb019712e16145550302148ef
    domain: light
  - type: turn_on
    device_id: db2f7007d9ab40883ebc98eba9815384
    entity_id: dc2d1b19833aaac2ea089fe8a751574f
    domain: light
  mode: single
- id: '1758396392046'
  alias: Kiffzimmer Licht an
  description: ''
  triggers:
  - type: opened
    device_id: f93ac770d48247a87eb45dca8a25b323
    entity_id: 3d6d3623a068fc9a1a1a1cff07e62437
    domain: binary_sensor
    trigger: device
  conditions:
  - condition: device
    type: is_off
    device_id: 506014673a62ba6c5f6209669bd9108e
    entity_id: dffd9b9d1f6f62069519afe1dc9dfb1e
    domain: light
  actions:
  - type: turn_on
    device_id: 506014673a62ba6c5f6209669bd9108e
    entity_id: dffd9b9d1f6f62069519afe1dc9dfb1e
    domain: light
  mode: single
- id: '1758396434802'
  alias: Kiffzimmer Licht aus
  description: ''
  triggers:
  - type: opened
    device_id: f93ac770d48247a87eb45dca8a25b323
    entity_id: 3d6d3623a068fc9a1a1a1cff07e62437
    domain: binary_sensor
    trigger: device
  conditions:
  - condition: device
    type: is_on
    device_id: 506014673a62ba6c5f6209669bd9108e
    entity_id: dffd9b9d1f6f62069519afe1dc9dfb1e
    domain: light
  actions:
  - type: turn_off
    device_id: 506014673a62ba6c5f6209669bd9108e
    entity_id: dffd9b9d1f6f62069519afe1dc9dfb1e
    domain: light
  mode: single
- id: '1758397268690'
  alias: Kiffzimmer Luftfeuchte <60%
  description: ''
  triggers:
  - type: humidity
    device_id: 489c7522969073f4aebaf5f0a180e34d
    entity_id: 607abb010b4820cb32e5de6a8cab8022
    domain: sensor
    trigger: device
    above: 60
    for:
      hours: 0
      minutes: 2
      seconds: 0
  conditions: []
  actions:
  - type: turn_on
    device_id: 59f76e362f5e4362255fbc7a3e14661f
    entity_id: c0d7c1a96441be922517ad7e01a9034c
    domain: switch
  mode: single
- id: '1758397358395'
  alias: Kiffzimmer Luftfeuchte >50%
  description: ''
  triggers:
  - type: humidity
    device_id: 489c7522969073f4aebaf5f0a180e34d
    entity_id: 607abb010b4820cb32e5de6a8cab8022
    domain: sensor
    trigger: device
    below: 50
    for:
      hours: 0
      minutes: 2
      seconds: 0
  conditions: []
  actions:
  - type: turn_off
    device_id: 59f76e362f5e4362255fbc7a3e14661f
    entity_id: c0d7c1a96441be922517ad7e01a9034c
    domain: switch
  mode: single
- id: '1758571949778'
  alias: Nicht zuhause
  description: ''
  triggers:
  - device_id: efc0fbc0e085a2eb506a22d2f5976e18
    domain: device_tracker
    entity_id: 36cb715257f356e7104d152159a4feef
    type: not_home
    trigger: device
    zone: zone.haus
  conditions: []
  actions:
  - type: turn_off
    device_id: 09da8d97be4777a9a94cc9b8e53d68c4
    entity_id: bc0d3fd25e385f3c1056ed9ead8aa858
    domain: light
  - type: turn_off
    device_id: 054f3b654c081cacaf8e2610359d7229
    entity_id: 638f7a53c21a6aeebbbe4c70bb9fa1df
    domain: light
  - type: turn_off
    device_id: ceb5bc29b2669f8871ae800bca1807a7
    entity_id: a5ec8243261c2ded541e37e7638fa2b7
    domain: light
  - type: turn_off
    device_id: dff6231b45ad4abd9fec55f83af21d78
    entity_id: e1a3c27842ab023629bd0c3d766dc5fc
    domain: light
  - type: turn_off
    device_id: 506014673a62ba6c5f6209669bd9108e
    entity_id: dffd9b9d1f6f62069519afe1dc9dfb1e
    domain: light
  - type: turn_off
    device_id: e41e61934b62b8d7c474eddae88bc93e
    entity_id: b2a67ac8aeeea1850c6ae4d3b41f8895
    domain: light
  - type: turn_off
    device_id: 3eb1ab346e4917536b2108c5aa33c616
    entity_id: f7aae072f642bae85c9a5b4faafb127a
    domain: light
  - type: turn_off
    device_id: 76361dfbed405867437d4b94a3995bb6
    entity_id: c89deabc4968aea0ddb6510f196c0c0b
    domain: light
  - type: turn_off
    device_id: 76361dfbed405867437d4b94a3995bb6
    entity_id: 188204738533536bc636218e65a74b53
    domain: fan
  - type: turn_off
    device_id: 76361dfbed405867437d4b94a3995bb6
    entity_id: c89deabc4968aea0ddb6510f196c0c0b
    domain: light
  - type: turn_off
    device_id: 3586709559e4e46394dfa54ebf906373
    entity_id: a14baab7198c0de3311dbee8b11fedab
    domain: fan
  - type: turn_off
    device_id: 274a4e3fba305eef548db23296690d2d
    entity_id: 708363eeb019712e16145550302148ef
    domain: light
  - type: turn_off
    device_id: db2f7007d9ab40883ebc98eba9815384
    entity_id: dc2d1b19833aaac2ea089fe8a751574f
    domain: light
  - type: turn_off
    device_id: 506014673a62ba6c5f6209669bd9108e
    entity_id: dffd9b9d1f6f62069519afe1dc9dfb1e
    domain: light
  mode: single
- id: '1758657223914'
  alias: Rollladen zu Sonnenuntergang
  description: ''
  triggers:
  - trigger: sun
    event: sunset
    offset: 0
  conditions: []
  actions:
  - device_id: a5ba8496ac9b401f09981a9877fe169f
    domain: cover
    entity_id: fc8f01df212c1c6f9e221f588a0cc872
    type: close
  - device_id: 6bb6441e87e544e859d1ca626d69e166
    domain: cover
    entity_id: 907f0e83e086aa3dbb94795ad8101a99
    type: close
  - device_id: 229f56948b85a1750d3f79623b6e471a
    domain: cover
    entity_id: 6bdb46108f7f0e78488ad459824254cb
    type: close
  mode: single
- id: '1758657307399'
  alias: Rollladen auf Sonnenaufgang
  description: ''
  triggers:
  - trigger: sun
    event: sunrise
    offset: 0
  conditions: []
  actions:
  - device_id: a5ba8496ac9b401f09981a9877fe169f
    domain: cover
    entity_id: fc8f01df212c1c6f9e221f588a0cc872
    type: open
  - device_id: 6bb6441e87e544e859d1ca626d69e166
    domain: cover
    entity_id: 907f0e83e086aa3dbb94795ad8101a99
    type: open
  - device_id: 229f56948b85a1750d3f79623b6e471a
    domain: cover
    entity_id: 6bdb46108f7f0e78488ad459824254cb
    type: open
  mode: single
  alias: Sicherheit â€“ Wasserleck Alarm
  description: Sofortige Benachrichtigung + Heizung aus bei Wasserleck
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.aqara_water_leak_sensor_feuchte
      to: 'on'
  action:
    # Kritische Push-Benachrichtigung
    - service: notify.alexa_media_wohnzimmer
      data:
        title: "ðŸ’§ WASSERLECK ERKANNT!"
        message: "Wassersensor hat Feuchtigkeit erkannt! SOFORT PRÃœFEN!"
        data:
          priority: high
          ttl: 0
          channel: alarm
          color: red

    # Alexa Durchsage
    - service: notify.alexa_media_wohnzimmer
      data:
        message: >
          <amazon:domain name="urgent">
          Achtung! Wasserleck erkannt. Bitte sofort den Wassersensor prÃ¼fen!
          </amazon:domain>
        data:
          type: announce
          method: all

    # Heizung ausschalten (Sicherheit bei Rohrbruch)
    - service: climate.turn_off
      target:
        entity_id:
          - climate.thermostat_bad
          - climate.thermostat_computer

# ---------- 3. LOW BATTERY WARNUNG ----------
- id: battery_low_warning
  alias: Wartung â€“ Low Battery Warnung (Sonntags)
  description: WÃ¶chentliche Benachrichtigung Ã¼ber schwache Batterien
  mode: single
  trigger:
    - platform: time
      at: '10:00:00'
  condition:
    - condition: time
      weekday: [sun]

    # Nur wenn mindestens 1 GerÃ¤t <20% hat
    - condition: template
      value_template: >
        {{ states.sensor
           | selectattr('attributes.device_class', 'eq', 'battery')
           | selectattr('state', 'is_number')
           | selectattr('state', 'lt', 20)
           | list | count > 0 }}
  action:
    - service: notify.alexa_media_wohnzimmer
      data:
        title: "ðŸ”‹ Batterien prÃ¼fen"
        message: >
          Folgende GerÃ¤te haben schwache Batterien (<20%):
          {% for state in states.sensor | selectattr('attributes.device_class', 'eq', 'battery') | selectattr('state', 'is_number') | selectattr('state', 'lt', 20) %}
          â€¢ {{ state.name }}: {{ state.state }}%
          {% endfor %}

# ---------- 4. GERÃ„TE OFFLINE WARNUNG ----------
- id: devices_offline_warning
  alias: Wartung â€“ GerÃ¤te Offline Warnung
  description: Benachrichtigung wenn wichtige GerÃ¤te lÃ¤nger offline
  mode: single
  trigger:
    # PrÃ¼fe alle 6 Stunden
    - platform: time_pattern
      hours: "/6"
  condition:
    # Nur wenn mindestens 1 wichtiges GerÃ¤t unavailable
    - condition: template
      value_template: >
        {{ states
           | selectattr('entity_id', 'in', [
               'binary_sensor.aqara_door_and_window_sensor_tur',
               'binary_sensor.aqara_water_leak_sensor_feuchte',
               'binary_sensor.presence_sensor_fp2_f9cf_presence',
               'climate.thermostat_bad',
               'climate.thermostat_computer'
             ])
           | selectattr('state', 'eq', 'unavailable')
           | list | count > 0 }}
  action:
    - service: notify.alexa_media_wohnzimmer
      data:
        title: "âš ï¸ GerÃ¤te Offline"
        message: >
          Folgende wichtige GerÃ¤te sind offline:
          {% for state in states | selectattr('entity_id', 'in', ['binary_sensor.aqara_door_and_window_sensor_tur', 'binary_sensor.aqara_water_leak_sensor_feuchte', 'binary_sensor.presence_sensor_fp2_f9cf_presence', 'climate.thermostat_bad', 'climate.thermostat_computer']) | selectattr('state', 'eq', 'unavailable') %}
          â€¢ {{ state.name }}
          {% endfor %}

          Batterie oder Verbindung prÃ¼fen!

# ---------- 5. HOME ASSISTANT UPDATE VERFÃœGBAR ----------
- id: ha_update_notification
  alias: Wartung â€“ Home Assistant Update verfÃ¼gbar
  description: Benachrichtigung bei verfÃ¼gbaren HA Updates
  mode: single
  trigger:
    - platform: state
      entity_id: update.home_assistant_core_update
      to: 'on'
    - platform: state
      entity_id: update.home_assistant_supervisor_update
      to: 'on'
  action:
    - service: notify.alexa_media_wohnzimmer
      data:
        title: "ðŸ”„ Home Assistant Update"
        message: >
          Ein Update ist verfÃ¼gbar:
          {{ trigger.to_state.attributes.title }}
          {{ trigger.to_state.attributes.installed_version }} â†’ {{ trigger.to_state.attributes.latest_version }}


# ============================================================================
# ðŸŸ  KATEGORIE 2: ENERGIESPAREN
# ============================================================================

# ---------- 6. STANDBY-KILLER NACHT ----------
- id: standby_killer_nacht
  alias: Energie â€“ Standby-GerÃ¤te Nacht aus
  description: Schaltet unnÃ¶tige GerÃ¤te nachts aus wenn keine Bewegung
  mode: single
  trigger:
    - platform: time
      at: '23:30:00'
  condition:
    # Nur wenn 30 Min keine Bewegung
    - condition: state
      entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence
      state: 'off'
      for:
        minutes: 30
  action:
    # Hier deine Steckdosen/Switches fÃ¼r Standby-GerÃ¤te
    # Beispiele - ANPASSEN an deine GerÃ¤te!
    - service: switch.turn_off
      target:
        entity_id:
          - switch.waschmaschine
          # - switch.monitor_steckdose
          # - switch.drucker
      continue_on_error: true

# ---------- 7. HEIZUNG SMART (FENSTER AUF/ZU) ----------
# Diese ersetzt deine alte "Heizung Aus Fenster offen" Automation!
- id: heizung_fenster_auto_smart
  alias: Energie â€“ Heizung automatisch bei Fenster
  description: Heizung aus bei offenen Fenstern, wieder AN wenn alle zu
  mode: restart
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.aqara_door_and_window_sensor_tur
        - binary_sensor.aqara_door_and_window_sensor_tur_2
  action:
    - choose:
        # FALL 1: Mindestens EIN Fenster auf â†’ Heizung AUS
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: binary_sensor.aqara_door_and_window_sensor_tur
                  state: 'on'
                - condition: state
                  entity_id: binary_sensor.aqara_door_and_window_sensor_tur_2
                  state: 'on'
          sequence:
            - service: climate.set_hvac_mode
              target:
                entity_id:
                  - climate.thermostat_bad
                  - climate.thermostat_computer
              data:
                hvac_mode: 'off'

        # FALL 2: ALLE Fenster zu â†’ Heizung wieder AN
        - conditions:
            - condition: state
              entity_id: binary_sensor.aqara_door_and_window_sensor_tur
              state: 'off'
            - condition: state
              entity_id: binary_sensor.aqara_door_and_window_sensor_tur_2
              state: 'off'
            # Nur wenn drauÃŸen kalt
            - condition: numeric_state
              entity_id: sensor.openweathermap_temperature
              below: 18
          sequence:
            # Kurz warten (nicht sofort wieder an)
            - delay:
                minutes: 2

            - service: climate.set_hvac_mode
              target:
                entity_id:
                  - climate.thermostat_bad
                  - climate.thermostat_computer
              data:
                hvac_mode: 'heat'

# ---------- 8. LICHT AUS BEI HELLIGKEIT ----------
- id: licht_aus_bei_helligkeit
  alias: Energie â€“ Licht aus bei Helligkeit >400 lux
  description: Schaltet Lichter aus wenn genug Tageslicht vorhanden
  mode: restart
  trigger:
    - platform: numeric_state
      entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level
      above: 500
      for:
        minutes: 5

  action:
    # Nur Lichter die nicht manuell an sein sollen
    - service: light.turn_off
      target:
        entity_id:
          - light.kuche_birne_1
          - light.kuche_birne_2
          - light.wohnzimmer_licht
          - light.computer_licht
          - light.buffet_lichtstreifen
          - light.KÃ¼chenlicht
          - light.KÃ¼che
      continue_on_error: true

# ---------- 9. GERÃ„TE AUS BEI LÃ„NGERER ABWESENHEIT ----------
- id: abwesenheit_lang_geraete_aus
  alias: Energie â€“ GerÃ¤te aus bei Abwesenheit >2h
  description: Schaltet mehr GerÃ¤te aus wenn lÃ¤nger weg
  mode: single
  trigger:
    - platform: state
      entity_id: person.reid15
      to: 'not_home'
      for:
        hours: 0.5
  action:
    # Heizung runterdrehen (nicht aus!)
    - service: climate.set_temperature
      target:
        entity_id:
          - climate.thermostat_bad
          - climate.thermostat_computer
      data:
        temperature: 17

    # Alle nicht-kritischen GerÃ¤te aus
    - service: light.turn_off
      target:
        entity_id: all

    - service: fan.turn_off
      target:
        entity_id: all


# ============================================================================
# ðŸŸ¡ KATEGORIE 3: KOMFORT & ROUTINEN
# ============================================================================

# ---------- 10. MORGENBEGRÃœSSUNG WERKTAGS ----------
- id: morgen_routine_werk
  alias: Routine â€“ Guten Morgen (Mo-Fr)
  description: RolllÃ¤den, Licht, Wetteransage
  mode: single
- choose:
      - conditions:
          - condition: sun
            after: sunset
  condition:
    - condition: time
      weekday: [mon, tue, wed, thu, fri]
  action:
    # RolllÃ¤den Ã¶ffnen (auÃŸer Computer wegen Blendung)
    - service: cover.open_cover
      target:
        entity_id:
          - cover.kuche_blind_vorhang
          - cover.yoga_blind_vorhang
          - cover.schlafen_blind_vorhang

    # KÃ¼chenlicht gedimmt
    - action: light.turn_on
      target:
        entity_id: light.kuche_birne_1
      data:
        brightness_pct: 100
        color_temp_kelvin: 3500

    # Warte 5 Minuten
    - delay:
        minutes: 5

    # Wetteransage
    - service: notify.alexa_media_wohnzimmer
      data:
        message: >
          Guten Morgen! Die Temperatur betrÃ¤gt aktuell
          {{ states('sensor.openweathermap_temperature') | round(0) }} Grad.
          {% if states('sensor.openweathermap_condition') == 'rainy' %}
          Es regnet heute. Vergiss den Regenschirm nicht!
          {% elif states('sensor.openweathermap_condition') == 'sunny' %}
          Es wird sonnig heute!
          {% endif %}
        data:
          type: tts

# ---------- 11. GUTE-NACHT-ROUTINE ----------
- id: gute_nacht_routine
  alias: Routine â€“ Gute Nacht (23:00)
  description: Alles ausschalten, RolllÃ¤den zu, Heizung runter
  mode: single
  trigger:
    - platform: time
      at: '23:00:00'
  condition:
    # Nur wenn 30 Min keine Bewegung
    - condition: state
      entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence
      state: 'off'
      for:
        minutes: 30
  action:
    # Alle RolllÃ¤den schlieÃŸen
    - service: cover.close_cover
      target:
        entity_id: all

    # Alle Lichter auÃŸer Schlafzimmer aus
    - service: light.turn_off
      target:
        entity_id: all

    # Heizung Nachtabsenkung
    - service: climate.set_temperature
      target:
        entity_id:
          - climate.thermostat_bad
          - climate.thermostat_computer
      data:
        temperature: 18

    # Ventilatoren aus
    - service: fan.turn_off
      target:
        entity_id: all


# ---------- 13. WILLKOMMEN ZUHAUSE ----------
- id: willkommen_zuhause
  alias: Routine â€“ Willkommen Zuhause
  description: Licht + Heizung an wenn nach Hause kommst
  mode: single
  trigger:
    - platform: state
      entity_id: person.reid15
      to: 'home'
  condition:
    # Nur wenn vorher >30 Min weg
    - condition: state
      entity_id: person.reid15
      state: 'not_home'
      for:
        minutes: 30
  action:
    # Heizung auf Komfort
    - service: climate.set_temperature
      target:
        entity_id:
          - climate.thermostat_computer
          - climate.thermostat_bad
      data:
        temperature: 23

    # Wenn dunkel: Lichter an
    - choose:
        - conditions:
            - condition: sun
              after: sunset
          sequence:
            - service: light.turn_on
              target:
                entity_id:
                  - light.kuche_birne_1
                  - light.wohnzimmer_licht
                  - light.buffet_lichtstreifen
                  - light.computer_licht
                  - light.computer_lichtt
              data:
                brightness_pct: 100

    # WillkommensgruÃŸ
    - service: notify.alexa_media_wohnzimmer
      data:
        message: "Willkommen zuhause!"
        data:
          type: tts

# ---------- 14. VERLASSEN-ROUTINE ----------
# Bereits vorhanden als "Nicht zuhause", aber hier verbesserte Version:
- id: verlassen_routine_improved
  alias: Routine â€“ Verlassen (verbessert)
  description: Alles ausschalten beim Verlassen, mit Szene
  mode: single
  trigger:
    - platform: state
      entity_id: person.reid15
      from: 'home'
      to: 'not_home'
      for:
        minutes: 5  # VerzÃ¶gerung gegen Fehlalarme
  action:
    # Nutze Szene "Alles aus" (falls erstellt)
    - service: scene.turn_on
      target:
        entity_id: scene.alles_aus
      continue_on_error: true

    # Oder manuell:
    - service: light.turn_off
      target:
        entity_id: all

    - service: fan.turn_off
      target:
        entity_id: all

    # RolllÃ¤den schlieÃŸen (Sicherheit)
    - service: cover.close_cover
      target:
        entity_id: all


# ============================================================================
# ðŸŸ¢ KATEGORIE 4: LUFTQUALITÃ„T & KLIMA
# ============================================================================

# ---------- 15. GROWBOX KLIMA-AUTOMATION ----------
- id: kiffzimmer_klima_auto
  alias: Growbox â€“ Klima Automation
  description: Temperatur & Luftfeuchtigkeit optimieren
  mode: restart
  trigger:
    - platform: numeric_state
      entity_id: sensor.sbht_003c_7ff9_temperature
      above: 28
      for:
        minutes: 5

    - platform: numeric_state
      entity_id: sensor.sbht_003c_7ff9_temperature
      below: 18
      for:
        minutes: 5

    - platform: numeric_state
      entity_id: sensor.sbht_003c_7ff9_humidity
      above: 65
      for:
        minutes: 10

    - platform: numeric_state
      entity_id: sensor.sbht_003c_7ff9_humidity
      below: 40
      for:
        minutes: 10
  action:
    - choose:
        # Zu heiÃŸ â†’ LÃ¼fter AN
        - conditions:
            - condition: numeric_state
              entity_id: sensor.sbht_003c_7ff9_temperature
              above: 28
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.growbox

        # Zu kalt â†’ LÃ¼fter AUS
        - conditions:
            - condition: numeric_state
              entity_id: sensor.sbht_003c_7ff9_temperature
              below: 18
          sequence:
            - service: switch.turn_off
              target:
                entity_id: switch.growbox

        # Zu feucht â†’ Entfeuchter AN
        - conditions:
            - condition: numeric_state
              entity_id: sensor.sbht_003c_7ff9_humidity
              above: 65
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.growbox

        # Zu trocken â†’ Entfeuchter AUS
        - conditions:
            - condition: numeric_state
              entity_id: sensor.sbht_003c_7ff9_humidity
              below: 40
          sequence:
            - service: switch.turn_off
              target:
                entity_id: switch.growbox

# ---------- 16. INTELLIGENTE LÃœFTUNGSERINNERUNG ----------
- id: luftqualitat_warnung
  alias: LuftqualitÃ¤t â€“ LÃ¼ftungserinnerung
  description: Erinnerung zum LÃ¼ften bei schlechter Luft
  mode: single
  trigger:
    # Hohe Luftfeuchtigkeit
    - platform: numeric_state
      entity_id: sensor.presence_sensor_fp2_f9cf_humidity
      above: 70
      for:
        minutes: 15

    # Oder: Lange kein Fenster auf (falls Sensor vorhanden)
    - platform: state
      entity_id: binary_sensor.aqara_door_and_window_sensor_tur
      to: 'off'
      for:
        hours: 4
  condition:
    # Nur wenn jemand zuhause
    - condition: state
      entity_id: person.reid15
      state: 'home'
  action:
    - service: notify.alexa_media_wohnzimmer
      data:
        message: "Die LuftqualitÃ¤t ist schlecht. Bitte lÃ¼ften!"
        data:
          type: announce

# ---------- 17. ENTFEUCHTER BEI HOHER LUFTFEUCHTIGKEIT ----------
# Bereits vorhanden in deinen Automationen, aber hier optimierte Version:
- id: entfeuchter_auto_smart
  alias: Klima â€“ Entfeuchter automatisch (60-50%)
  description: Entfeuchter AN >60%, AUS <50%
  mode: restart
  trigger:
    - platform: numeric_state
      entity_id: sensor.sbht_003c_7ff9_humidity
      above: 60
      for:
        minutes: 10

    - platform: numeric_state
      entity_id: sensor.sbht_003c_7ff9_humidity
      below: 50
      for:
        minutes: 5
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.sbht_003c_7ff9_humidity
              above: 60
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.growbox

        - conditions:
            - condition: numeric_state
              entity_id: sensor.sbht_003c_7ff9_humidity
              below: 50
          sequence:
            - service: switch.turn_off
              target:
                entity_id: switch.growbox

# ---------- 18. HEIZUNG NACHTABSENKUNG ----------
- id: heizung_nachtabsenkung
  alias: Klima â€“ Heizung Nachtabsenkung (22:00-05:00)
  description: Senkt Heizung nachts automatisch
  mode: single
  trigger:
    # Abends runter
    - platform: time
      at: '22:00:00'
      id: down

    # Morgens hoch
    - platform: time
      at: '05:00:00'
      id: up
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: down
          sequence:
            - service: climate.set_temperature
              target:
                entity_id:
                  - climate.thermostat_bad
                  - climate.thermostat_computer
              data:
                temperature: 18

        - conditions:
            - condition: trigger
              id: up
          sequence:
            - service: climate.set_temperature
              target:
                entity_id:
                  - climate.thermostat_bad
                  - climate.thermostat_computer
              data:
                temperature: 21


# ============================================================================
# ðŸ”µ KATEGORIE 5: ZEITGESTEUERTE AUTOMATIONEN
# ============================================================================

# ---------- 19. ROLLLADEN ZEITSTEUERUNG WERKTAG/WOCHENENDE ----------
# Ersetzt deine aktuellen Sonnenauf-/untergang Automationen!

# Morgens Werktag
- id: roller_morgen_werktag
  alias: Rollladen â€“ Morgens Werktag (07:00)
  mode: single
  trigger:
    - platform: time
      at: '07:00:00'
  condition:
    - condition: time
      weekday: [mon, tue, wed, thu, fri]
  action:
    - service: cover.open_cover
      target:
        entity_id:
          - cover.kuche_blind_vorhang
          - cover.yoga_blind_vorhang

# Morgens Wochenende (spÃ¤ter!)
- id: roller_morgen_wochenende
  alias: Rollladen â€“ Morgens Wochenende (09:00)
  mode: single
  trigger:
    - platform: time
      at: '09:00:00'
  condition:
    - condition: time
      weekday: [sat, sun]
  action:
    - service: cover.open_cover
      target:
        entity_id:
          - cover.kuche_blind_vorhang
          - cover.yoga_blind_vorhang

# Abends (alle Tage)
- id: roller_abend_alle
  alias: Rollladen â€“ Abends (22:00)
  mode: single
  trigger:
    - platform: time
      at: '22:00:00'
  action:
    - service: cover.close_cover
      target:
        entity_id: all

# ---------- 20. LICHT-SZENEN ZEITGESTEUERT ----------
- id: licht_szenen_zeit
  alias: Licht â€“ Szenen zeitgesteuert
  description: Verschiedene Lichtszenen Ã¼ber den Tag
  mode: restart
  trigger:
    - platform: time
      at: '06:00:00'
      id: morning

    - platform: time
      at: '18:00:00'
      id: evening

    - platform: time
      at: '22:00:00'
      id: night
  condition:
    # Nur wenn jemand zuhause
    - condition: state
      entity_id: person.reid15
      state: 'home'
  action:
    - choose:
        # Morgens: Tageslicht
        - conditions:
            - condition: trigger
              id: morning
          sequence:
            - service: light.turn_on
              target:
                entity_id:
                  - light.kuche_birne_1
                  - light.wohnzimmer_licht
                  - light.computer_licht
                  - light.bad_licht
                  - light.bett_lichtstreifen
                  - light.buffet_lichtstreifen
              data:
                brightness_pct: 70
                color_temp_kelvin: 4000

        # Abends: WarmweiÃŸ
        - conditions:
            - condition: trigger
              id: evening
          sequence:
            - service: light.turn_on
              target:
                entity_id:
                  - light.wohnzimmer_licht
                  - light.computer_licht
                  - light.buffet_lichtstreifen
                  - light.dc_fan_lamp
                  - light.KÃ¼chenlicht
              data:
                brightness_pct: 100
                color_temp_kelvin: 2700


# ---------- 21. WOCHENEND-WECKROUTINE ----------
- id: weckroutine_wochenende
  alias: Routine â€“ Wochenend-Weckroutine (09:00)
  description: Sanftes Wecken am Wochenende
  mode: single
  trigger:
    - platform: time
      at: '11:00:00'
  condition:
    - condition: time
      weekday: [sat, sun]
  action:
    # RolllÃ¤den sanft Ã¶ffnen
    - service: cover.open_cover
      target:
        entity_id: cover.schlafen_blind_vorhang

    # Licht sanft hochdimmen
    - service: light.turn_on
      target:
        entity_id: light.schlafzimmer_licht
      data:
        brightness_pct: 1

    - service: light.turn_on
      target:
        entity_id: light.schlafzimmer_licht
      data:
        brightness_pct: 100
        transition: 600  # 10 Minuten

    # Kaffee-Erinnerung (optional)
    - delay:
        minutes: 5
    - service: notify.alexa_media_wohnzimmer
      data:
        message: "Guten Morgen! Zeit fÃ¼r einen Kaffee!"
        data:
          type: tts


# ============================================================================
# ENDE DER AUTOMATIONEN
# ============================================================================
#
# NÃ„CHSTE SCHRITTE:
# 1. Entity-IDs anpassen (marked mit â† ANPASSEN!)
# 2. Zeiten & Schwellenwerte nach deinen BedÃ¼rfnissen Ã¤ndern
# 3. FÃ¼ge zu automations.yaml hinzu
# 4. YAML neu laden
# 5. Teste jede Automation einzeln
#
# ============================================================================
# ============================================================================
# NEUE COVER AUTOMATIONEN - Re-Kalibrierung & Testing
# FÃ¼ge diese zu deiner automations.yaml hinzu
# ============================================================================

# ========== RE-KALIBRIERUNG ==========
# Jeden Tag um 03:00 Uhr: Alle RolllÃ¤den komplett schlieÃŸen und Position auf 0 setzen
# Verhindert Drift nach vielen Teilfahrten

- id: cover_rekalibrierung_nacht
  alias: Cover â€“ Re-Kalibrierung (tÃ¤glich 03:00)
  description: SchlieÃŸt alle RolllÃ¤den vollstÃ¤ndig und setzt Position-Helper auf 0
  mode: single
  trigger:
    - platform: time
      at: '03:00:00'
  action:
    # 1. Alle RolllÃ¤den schlieÃŸen
    - service: cover.close_cover
      target:
        entity_id:
          - rollladen_computer_vorhang
          - rollladen_kuche_vorhang
          - rollladen_yoga_vorhang
          - rollladen_schlafen_vorhang
      continue_on_error: true

    # 2. Warten bis alle geschlossen (30s sollte reichen)
    - delay:
        seconds: 30

    # 3. Position-Helper nicht mehr benÃ¶tigt (entfernt - verwenden jetzt Timing-basierte Steuerung)

    # 4. Logging
    - service: system_log.write
      data:
        message: "Cover Re-Kalibrierung abgeschlossen - Alle Position-Helper auf 0 gesetzt"
        level: info


# ========== TEST: PARTIAL MOVE ==========
# Testet ob Teilfahrten (z.B. 50%) korrekt funktionieren

- id: test_cover_partial_move
  alias: TEST â€“ Cover Teilfahrt (50%)
  description: Testet ob 50% Position korrekt angefahren wird
  mode: single
  trigger:
    - platform: event
      event_type: test_cover_partial
  variables:
    test_cover: "cover.rollladen_computer_vorhang"
  action:
    # 1. Komplett schlieÃŸen & kalibrieren
    - service: cover.close_cover
      target:
        entity_id: "{{ test_cover }}"
    - delay:
        seconds: 30

    # 2. Info
    - service: persistent_notification.create
      data:
        notification_id: cover_test_partial
        title: "ðŸ§ª Partial Move Test"
        message: "Cover geschlossen. Fahre jetzt auf 50%..."

    # 3. Auf 50% fahren (10.5 Sekunden = 50% von 21 Sekunden)
    - service: cover.open_cover
      target:
        entity_id: "{{ test_cover }}"
    - delay:
        seconds: 10.5
    - service: cover.stop_cover
      target:
        entity_id: "{{ test_cover }}"

    # 4. Warten + Ergebnis
    - delay:
        seconds: 2
    - service: persistent_notification.create
      data:
        notification_id: cover_test_partial
        title: "ðŸ§ª Partial Move Test - Ergebnis"
        message: >
          **Test abgeschlossen!**

          Cover sollte jetzt bei **50%** sein.

          **PrÃ¼fe MANUELL:**
          - âœ… Etwa bei HÃ¤lfte? â†’ Travel Time korrekt!
          - âŒ Zu weit offen (>50%)? â†’ `travel_time` ERHÃ–HEN
          - âŒ Zu weit zu (<50%)? â†’ `travel_time` VERRINGERN

          **Helper-Position:** {{ states(test_helper) }}%
          **Cover-Status:** {{ states(test_cover) }}



# ============================================================================
# INTELLIGENTE HEIZUNGSSTEUERUNG - Wetter-basiert & Energie-sparend
# ============================================================================

# ---------- 1. HEIZUNG AUS BEI WARMER AUSSENTEMPERATUR ----------
- id: heizung_aus_warm_draussen
  alias: "Energie â€“ Heizung aus bei >18Â°C AuÃŸentemperatur"
  description: "Schaltet Heizung automatisch aus wenn es drauÃŸen warm genug ist"
  mode: restart
  trigger:
    # PrÃ¼fe alle 15 Minuten
    - platform: time_pattern
      minutes: "/15"

    # Sofort wenn Temperatur steigt
    - platform: numeric_state
      entity_id: sensor.openweathermap_temperature
      above: 18
      for:
        minutes: 10

    # Sofort wenn Temperatur fÃ¤llt
    - platform: numeric_state
      entity_id: sensor.openweathermap_temperature
      below: 17
      for:
        minutes: 10

  action:
    - choose:
        # FALL 1: DrauÃŸen >18Â°C â†’ Heizung AUS
        - conditions:
            - condition: numeric_state
              entity_id: sensor.openweathermap_temperature
              above: 18
          sequence:
            - service: climate.set_hvac_mode
              target:
                entity_id:
                  - climate.thermostat_bad
                  - climate.thermostat_computer
              data:
                hvac_mode: 'off'

            - service: persistent_notification.create
              data:
                notification_id: heizung_warm
                title: "ðŸŒ¡ï¸ Heizung aus"
                message: >
                  AuÃŸentemperatur: {{ states('sensor.openweathermap_temperature') }}Â°C
                  Heizung automatisch ausgeschaltet (Energie sparen)

        # FALL 2: DrauÃŸen <17Â°C â†’ Heizung AN (wenn nicht manuell eco)
        - conditions:
            - condition: numeric_state
              entity_id: sensor.openweathermap_temperature
              below: 17

            # Nur wenn nicht manuell Eco-Modus aktiviert
            - condition: state
              entity_id: input_boolean.heizung_eco_mode
              state: 'off'

          sequence:
            - service: climate.set_hvac_mode
              target:
                entity_id:
                  - climate.thermostat_bad
                  - climate.thermostat_computer
              data:
                hvac_mode: 'heat'

            # Setze auf Komfort-Temperatur
            - service: climate.set_temperature
              target:
                entity_id:
                  - climate.thermostat_bad
                  - climate.thermostat_computer
              data:
                temperature: "{{ states('input_number.heizung_solltemperatur_komfort')|float(23) }}"

# ---------- 2. HEIZUNG REDUZIEREN BEI SONNENEINSTRAHLUNG ----------
- id: heizung_reduzieren_sonne
  alias: "Energie â€“ Heizung reduzieren bei Sonneneinstrahlung"
  description: "Nutzt passive solare WÃ¤rme, reduziert Heizung bei Sonnenschein"
  mode: restart
  trigger:
    - platform: time_pattern
      minutes: "/10"

    - platform: numeric_state
      entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level
      above: 400
      for:
        minutes: 5

  condition:
    # Nur im Winter-Modus
    - condition: state
      entity_id: input_boolean.heizung_winter_mode
      state: 'on'

    # Nur wenn drauÃŸen kalt genug zum Heizen
    - condition: numeric_state
      entity_id: sensor.openweathermap_temperature
      below: 17

    # Nur tagsÃ¼ber
    - condition: sun
      after: sunrise
      before: sunset

  variables:
    # Sonne scheint gut ins Zimmer?
    sun_ok: >-
      {{ (state_attr('sun.sun','azimuth')|float(0) >= 120) and
         (state_attr('sun.sun','azimuth')|float(0) <= 240) and
         (state_attr('sun.sun','elevation')|float(0) > 20) }}

    lux: "{{ states('sensor.presence_sensor_fp2_f9cf_light_sensor_light_level')|int(0) }}"

  action:
    - choose:
        # FALL 1: Sonne scheint stark â†’ Heizung reduzieren (-2Â°C)
        - conditions:
            - condition: template
              value_template: "{{ sun_ok and lux > 600 }}"

          sequence:
            - service: climate.set_temperature
              target:
                entity_id:
                  - climate.thermostat_computer  # Nur Computer-Zimmer (SÃ¼d-Seite)
              data:
                temperature: >
                  {{ [states('input_number.heizung_solltemperatur_komfort')|float(23) - 2, 18]|max }}

            - service: persistent_notification.create
              data:
                notification_id: heizung_sonne
                title: "â˜€ï¸ Passive Solarheizung"
                message: >
                  Sonneneinstrahlung: {{ lux }} lux
                  Heizung reduziert (nutzt kostenlose SonnenwÃ¤rme)

      # FALL 2: Keine/wenig Sonne â†’ Normale Temperatur
      default:
        - service: climate.set_temperature
          target:
            entity_id:
              - climate.thermostat_computer
          data:
            temperature: "{{ states('input_number.heizung_solltemperatur_komfort')|float(23) }}"

# ---------- 3. MORGENS VORHEIZEN BEI KALTER WETTERVORHERSAGE ----------
- id: heizung_vorheizen_kalt
  alias: "Energie â€“ Morgens vorheizen bei kaltem Tag"
  description: "Heizt morgens stÃ¤rker vor wenn kalter Tag vorhergesagt"
  mode: single
  trigger:
    - platform: time
      at: "05:00:00"

  condition:
    # Nur an Werktagen
    - condition: time
      weekday: [mon, tue, wed, thu, fri]

    # Nur wenn aktuell kalt drauÃŸen
    - condition: numeric_state
      entity_id: sensor.openweathermap_temperature
      below: 12

  variables:
    # Forecast fÃ¼r heute (TageshÃ¶chsttemperatur)
    forecast_temp: >
      {{ state_attr('weather.openweathermap', 'forecast')[0].temperature|float(15) }}

  action:
    - choose:
        # FALL 1: Kalter Tag vorhergesagt (<10Â°C) â†’ Stark vorheizen
        - conditions:
            - condition: template
              value_template: "{{ forecast_temp < 1 }}"

          sequence:
            - service: climate.set_temperature
              target:
                entity_id:
                  - climate.thermostat_bad
                  - climate.thermostat_computer
              data:
                temperature: 25  # +1Â°C Ã¼ber Komfort

            - service: persistent_notification.create
              data:
                notification_id: heizung_vorheizen
                title: "ðŸ¥¶ Vorheizen aktiv"
                message: >
                  Kalter Tag vorhergesagt (max {{ forecast_temp }}Â°C)
                  Heizung lÃ¤uft stÃ¤rker zum Vorheizen

      # FALL 2: MÃ¤ÃŸig kalt (10-15Â°C) â†’ Normal heizen
      default:
        - service: climate.set_temperature
          target:
            entity_id:
              - climate.thermostat_bad
              - climate.thermostat_computer
          data:
            temperature: "{{ states('input_number.heizung_solltemperatur_komfort')|float(23) }}"

# ---------- 4. ECO-MODUS BEI ABWESENHEIT ----------
- id: heizung_eco_abwesenheit
  alias: "Energie â€“ Eco-Modus bei Abwesenheit"
  description: "Senkt Heizung bei Abwesenheit, erhÃ¶ht bei Heimkehr"
  mode: restart
  trigger:
    # Abwesenheit erkannt
    - platform: state
      entity_id: binary_sensor.clt_l09_anwesenheit
      to: 'off'
      for:
        minutes: 30
      id: away

    # Heimkehr erkannt
    - platform: state
      entity_id: binary_sensor.clt_l09_anwesenheit
      to: 'on'
      id: home

  condition:
    # Nur wenn drauÃŸen kalt genug zum Heizen
    - condition: numeric_state
      entity_id: sensor.openweathermap_temperature
      below: 17

  action:
    - choose:
        # FALL 1: Weg â†’ Eco-Modus
        - conditions:
            - condition: trigger
              id: away

          sequence:
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.heizung_eco_mode

            - service: climate.set_temperature
              target:
                entity_id:
                  - climate.thermostat_bad
                  - climate.thermostat_computer
              data:
                temperature: "{{ states('input_number.heizung_solltemperatur_eco')|float(18) }}"

            - service: persistent_notification.create
              data:
                notification_id: heizung_eco
                title: "ðŸƒ Eco-Modus aktiv"
                message: >
                  Abwesenheit erkannt (>30 Min)
                  Heizung auf {{ states('input_number.heizung_solltemperatur_eco') }}Â°C gesenkt

        # FALL 2: Zuhause â†’ Komfort-Modus
        - conditions:
            - condition: trigger
              id: home

          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.heizung_eco_mode

            - service: climate.set_temperature
              target:
                entity_id:
                  - climate.thermostat_bad
                  - climate.thermostat_computer
              data:
                temperature: "{{ states('input_number.heizung_solltemperatur_komfort')|float(23) }}"

            - service: persistent_notification.create
              data:
                notification_id: heizung_komfort
                title: "ðŸ  Willkommen!"
                message: >
                  Heizung auf Komfort-Modus
                  Zieltemperatur: {{ states('input_number.heizung_solltemperatur_komfort') }}Â°C

# ---------- 5. NACHTABSENKUNG ----------
- id: heizung_nachtabsenkung_smart
  alias: "Energie â€“ Nachtabsenkung (22:00-06:00)"
  description: "Senkt Heizung nachts automatisch"
  mode: single
  trigger:
    # Abends runter
    - platform: time
      at: "22:00:00"
      id: night

    # Morgens hoch
    - platform: time
      at: "06:00:00"
      id: morning

  condition:
    # Nur wenn drauÃŸen kalt
    - condition: numeric_state
      entity_id: sensor.openweathermap_temperature
      below: 17

  action:
    - choose:
        # Abends â†’ Nacht-Temperatur
        - conditions:
            - condition: trigger
              id: night

          sequence:
            - service: climate.set_temperature
              target:
                entity_id:
                  - climate.thermostat_bad
                  - climate.thermostat_computer
              data:
                temperature: "{{ states('input_number.heizung_solltemperatur_nacht')|float(17) }}"

        # Morgens â†’ Komfort (nur wenn zuhause)
        - conditions:
            - condition: trigger
              id: morning

            - condition: state
              entity_id: binary_sensor.clt_l09_anwesenheit
              state: 'on'

          sequence:
            - service: climate.set_temperature
              target:
                entity_id:
                  - climate.thermostat_bad
                  - climate.thermostat_computer
              data:
                temperature: "{{ states('input_number.heizung_solltemperatur_komfort')|float(23) }}"


# ---------- 7. WINTER-MODUS: ROLLLÃ„DEN FÃœR PASSIVE HEIZUNG ----------
- id: heizung_winter_rollladen
  alias: "Energie â€“ Winter-RolllÃ¤den (DÃ¤mmung + passive Heizung)"
  description: "Nutzt RolllÃ¤den im Winter: Nachts zu (DÃ¤mmung), tags bei Sonne auf (passive WÃ¤rme)"
  mode: restart
  trigger:
    # Sonnenaufgang
    - platform: sun
      event: sunrise
      offset: "00:30:00"
      id: morning

    # Sonnenuntergang
    - platform: sun
      event: sunset
      offset: "-00:30:00"
      id: evening


    # Nur wenn drauÃŸen kalt (Heizperiode)
    - condition: numeric_state
      entity_id: sensor.openweathermap_temperature
      below: 10

  action:
    - choose:
        # Morgens â†’ RolllÃ¤den AUF (passive Solarheizung)
        - conditions:
            - condition: trigger
              id: morning

          sequence:
            - service: cover.open_cover
              target:
                entity_id:
                  - cover.rollladen_computer_vorhang
                  - cover.kuche_blind_vorhang
                  - cover.yoga_blind_vorhang

        # Abends â†’ RolllÃ¤den ZU (WÃ¤rmedÃ¤mmung)
        - conditions:
            - condition: trigger
              id: evening

          sequence:
            - service: cover.close_cover
              target:
                entity_id:
                  - cover.rollladen_computer_vorhang
                  - cover.kuche_blind_vorhang
                  - cover.yoga_blind_vorhang
                  - cover.schlafen_blind_vorhang


# ============================================================================
#  HOME ASSISTANT AUTOMATIONS - REID'S SETUP
#  Last Updated: 2026-01-08
#  Structure:
#    1. GLOBAL & SECURITY (Away, Welcome, Vacation, Alerts)
#    2. LIVING ROOM & GAMING (Gaming, Movie, Ambient)
#    3. KITCHEN (Lights, Snacks)
#    4. BEDROOM (Wake-up, Sleep, Shutters)
#    5. BATHROOM (Lights, Heating)
#    6. CLIMATE & SHUTTERS (General Rules)
#    7. SYSTEM & MAINTENANCE (Roborock, Updates)
# ============================================================================

# ============================================================================
#  1. GLOBAL & SECURITY
# ============================================================================

- id: "global_welcome_home"
  alias: "Global - Willkommen zu Hause"
  description: "Turns on lights and boosts heating when you arrive home after sunset."
  trigger:
    - platform: state
      entity_id: person.reid15
      to: "home"
  condition:
    - condition: sun
      after: sunset
      before: sunrise
  action:
    - service: light.turn_on
      target:
        entity_id:
          - light.computer_licht_2
          - light.buffet_licht
          - light.rollladen_computer_hintergrundbeleuchtung
          - light.yoga_blind_hintergrundbeleuchtung
      data:
        brightness_pct: 80
        color_temp_kelvin: 2700
    # Boost heating in winter months (Nov-Feb)
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ now().month in [11, 12, 1, 2] }}"
          sequence:
            - service: climate.set_temperature
              target:
                entity_id:
                  - climate.thermostat_bad
                  - climate.thermostat_computer
              data:
                temperature: 23
  mode: single

- id: "global_away_mode"
  alias: "Global - Abwesenheitsmodus"
  description: "Turns off all lights and sets heating to Eco when you leave."
  trigger:
    - platform: state
      entity_id: person.reid15
      to: "not_home"
      for:
        minutes: 10
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.computer_licht_2
          - light.buffet_licht
          - light.rollladen_computer_hintergrundbeleuchtung
          - light.yoga_blind_hintergrundbeleuchtung
          - light.kuche_brine_1
          - light.kuche_birne_2_2
          - light.kuche_streifen
          - light.kuche_blind_hintergrundbeleuchtung
          - light.bad_2
          - light.bett_licht_2
          - light.schlafen_blind_hintergrundbeleuchtung
    - service: climate.set_temperature
      target:
        entity_id:
          - climate.thermostat_bad
          - climate.thermostat_computer
      data:
        temperature: 18
  mode: single

- id: "global_vacation_simulation"
  alias: "Global - Urlaubsmodus (Anwesenheitssimulation)"
  description: "Randomly toggles lights when Vacation Mode is active to simulate presence."
  trigger:
    - platform: state
      entity_id: input_boolean.vacation_mode
      to: "on"
  action:
    - repeat:
        while:
          - condition: state
            entity_id: input_boolean.vacation_mode
            state: "on"
        sequence:
          # Randomly turn on a light
          - service: light.turn_on
            target:
              entity_id: "{{ ['light.computer_licht_2', 'light.buffet_licht', 'light.kuche_brine_1', 'light.rollladen_computer_hintergrundbeleuchtung'] | random }}"
            data:
              brightness_pct: "{{ range(50, 100) | random }}"
          # Wait random time (30-120 mins)
          - delay:
              minutes: "{{ range(30, 120) | random }}"
          # Randomly turn off a light
          - service: light.turn_off
            target:
              entity_id: "{{ ['light.computer_licht_2', 'light.buffet_licht', 'light.kuche_brine_1', 'light.rollladen_computer_hintergrundbeleuchtung'] | random }}"
          - delay:
              minutes: "{{ range(15, 60) | random }}"
  mode: single

- id: "security_motion_alert"
  alias: "Sicherheit - Bewegung bei Abwesenheit"
  description: "Sends a notification if motion is detected while you are away."
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_2
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_3
      to: "on"
  condition:
    - condition: state
      entity_id: person.reid15
      state: "not_home"
      for:
        minutes: 30
  action:
    - service: notify.mobile_app_redmi_note_12_pro_5g
      data:
        title: "âš ï¸ Bewegung erkannt!"
        message: "Bewegung in deiner Wohnung wÃ¤hrend Abwesenheit"
  mode: single

- id: "security_door_alert"
  alias: "Sicherheit - TÃ¼r geÃ¶ffnet bei Abwesenheit"
  description: "Sends a notification if the door is opened while you are away."
  trigger:
    - platform: state
      entity_id: binary_sensor.contact_sensor
      to: "on"
  condition:
    - condition: state
      entity_id: person.reid15
      state: "not_home"
  action:
    - service: notify.mobile_app_redmi_note_12_pro_5g
      data:
        title: "ðŸšª TÃ¼r geÃ¶ffnet!"
        message: "Die TÃ¼r wurde geÃ¶ffnet wÃ¤hrend du nicht zuhause bist"
  mode: single

# ============================================================================
#  2. LIVING ROOM & GAMING
# ============================================================================

- id: "living_light_presence"
  alias: "Wohnzimmer - Licht bei PrÃ¤senz"
  description: "Turns on ambient lights when FP2 detects presence in Living Room zones."
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1 # Computer
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_2 # Couch
      to: "on"
    # Trigger on startup if already present
    - platform: homeassistant
      event: start
  condition:
    # Only when dark enough
    - condition: numeric_state
      entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level
      below: 50
    # Ensure presence is actually active (for startup trigger)
    - condition: or
      conditions:
        - condition: state
          entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1
          state: "on"
        - condition: state
          entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_2
          state: "on"
  action:
    - service: light.turn_on
      target:
        entity_id:
          - light.computer_licht_2
          - light.buffet_licht
          - light.rollladen_computer_hintergrundbeleuchtung
          - light.yoga_blind_hintergrundbeleuchtung
      data:
        brightness_pct: "{{ 60 if now().hour >= 22 or now().hour < 6 else 80 }}"
        color_temp_kelvin: 2700
  mode: single

- id: "living_light_off"
  alias: "Wohnzimmer - Licht aus ohne PrÃ¤senz"
  description: "Turns off lights after 120s of no presence in ANY living room zone."
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_2
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_3
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_4
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_5
      to: "off"
      for:
        seconds: 120
  condition:
    # Double check all zones are clear
    - condition: state
      entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1
      state: "off"
    - condition: state
      entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_2
      state: "off"
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.computer_licht_2
          - light.buffet_licht
          - light.rollladen_computer_hintergrundbeleuchtung
          - light.yoga_blind_hintergrundbeleuchtung
  mode: single

- id: "gaming_mode_activate"
  alias: "Gaming - Modus aktivieren (Cozy Fire)"
  description: "Activates Cozy Gaming Mode after 5 mins at computer. Starts fireplace effect."
  trigger:
    - platform: state
      entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1
      to: "on"
      for:
        minutes: 5
    # Trigger on startup/reload if already sitting there
    - platform: homeassistant
      event: start
  condition:
    - condition: time
      after: "08:00"
      before: "03:00"
    # Ensure user is actually there (for both triggers)
    - condition: state
      entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1
      state: "on"
      for:
        minutes: 5
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.gaming_mode
    # Chimney Fire Effect
    - service: script.turn_on
      target:
        entity_id: script.ambient_feuerlicht_warm_flicker
    # Cozy background lights
    - service: light.turn_on
      target:
        entity_id:
          - light.rollladen_computer_hintergrundbeleuchtung
          - light.yoga_blind_hintergrundbeleuchtung
      data:
        brightness_pct: 20
        color_temp_kelvin: 2000
  mode: single

- id: "gaming_mode_deactivate"
  alias: "Gaming - Modus deaktivieren"
  description: "Deactivates Gaming Mode when leaving computer area for 10 mins."
  trigger:
    - platform: state
      entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1
      to: "off"
      for:
        minutes: 10
  condition:
    - condition: state
      entity_id: input_boolean.gaming_mode
      state: "on"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.gaming_mode
    - service: light.turn_on
      target:
        entity_id:
          - light.computer_licht_2
          - light.buffet_licht
          - light.rollladen_computer_hintergrundbeleuchtung
          - light.yoga_blind_hintergrundbeleuchtung
      data:
        brightness_pct: 60
        color_temp_kelvin: 2700
  mode: single

- id: "gaming_anti_glare"
  alias: "Gaming - Blendschutz"
  description: "Closes computer shutter if gaming during bright daylight."
  trigger:
    - platform: state
      entity_id: input_boolean.gaming_mode
      to: "on"
  condition:
    - condition: sun
      after: sunrise
      before: sunset
    - condition: numeric_state
      entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level
      above: 100
  action:
    - service: cover.close_cover
      target:
        entity_id: cover.rollladen_computer_vorhang
  mode: single

- id: "movie_mode_activate"
  alias: "Wohnzimmer - Filmzeit"
  description: "Dims lights and closes shutters for Movie Mode."
  trigger:
    - platform: state
      entity_id: input_boolean.movie_mode
      to: "on"
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.kuche_brine_1
          - light.kuche_birne_2_2
          - light.kuche_blind_hintergrundbeleuchtung
    - service: light.turn_on
      target:
        entity_id:
          - light.buffet_licht
          - light.rollladen_computer_hintergrundbeleuchtung
          - light.yoga_blind_hintergrundbeleuchtung
      data:
        brightness_pct: 20
        color_temp_kelvin: 2200
    - service: light.turn_on
      target:
        entity_id: light.computer_licht_2
      data:
        brightness_pct: 10
        color_temp_kelvin: 2200
    - service: cover.close_cover
      target:
        entity_id: cover.rollladen_computer_vorhang
  mode: single

# ============================================================================
#  3. KITCHEN
# ============================================================================

- id: "kitchen_light_on"
  alias: "KÃ¼che - Licht an bei Bewegung"
  description: "Turns on kitchen lights. Respects Gaming Mode (snack break)."
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_kuche_bewegung
      to: "on"
  condition:
    # Check light level if available, otherwise just time based or always on
    - condition: or
      conditions:
        - condition: sun
          after: sunset
          before: sunrise
        - condition: numeric_state
          entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level # Use Living Room light sensor as proxy if needed, or remove
          below: 50
  action:
    - service: light.turn_on
      target:
        entity_id:
          - light.kuche_brine_1
          - light.kuche_birne_2_2
          - light.kuche_streifen
          - light.kuche_blind_hintergrundbeleuchtung
      data:
        brightness_pct: "{{ 50 if now().hour >= 22 else 100 }}"
        color_temp_kelvin: 2700
  mode: single

- id: "kitchen_light_off"
  alias: "KÃ¼che - Licht aus"
  description: "Turns off kitchen lights after 120s."
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_kuche_bewegung
      to: "off"
      for:
        seconds: 120
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.kuche_brine_1
          - light.kuche_birne_2_2
          - light.kuche_streifen
          - light.kuche_blind_hintergrundbeleuchtung
  mode: single

# ============================================================================
#  4. BEDROOM
# ============================================================================

- id: "bedroom_wakeup_weekday"
  alias: "Schlafzimmer - Wecker Werktag (05:00)"
  description: "Gradual wake-up light and heating boost for weekdays."
  trigger:
    - platform: time
      at: "04:30"
  condition:
    - condition: time
      weekday: [mon, tue, wed, thu, fri]
  action:
    # Heat up bathroom
    - service: climate.set_temperature
      target:
        entity_id: climate.thermostat_bad
      data:
        temperature: 23
    # Gradual Light (30 min)
    - service: light.turn_on
      target:
        entity_id:
          - light.bett_licht_2_2
          - light.schlafen_blind_hintergrundbeleuchtung
      data:
        brightness_pct: 5
        color_temp_kelvin: 2700
        transition: 1800
    # Open Shutters
    - delay:
        minutes: 30
    - service: cover.open_cover
      target:
        entity_id: cover.schlafen_blind_vorhang
  mode: single

- id: "bedroom_sleep_mode"
  alias: "Schlafzimmer - Schlafmodus Aktivieren"
  description: "Activates Sleep Mode if motion detected after 10 PM."
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_schlafen_bewegung
      to: "on"
      for:
        minutes: 15 # Assuming continuous motion/presence
  condition:
    - condition: time
      after: "22:00"
      before: "08:00"
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.computer_licht_2
          - light.buffet_licht
          - light.rollladen_computer_hintergrundbeleuchtung
          - light.yoga_blind_hintergrundbeleuchtung
          - light.kuche_birne_1
          - light.kuche_birne_2
          - light.kuche_streifen
          - light.kuche_blind_hintergrundbeleuchtung
          - light.bad_2
          - light.bett_licht_2
          - light.schlafen_blind_hintergrundbeleuchtung
    - service: cover.close_cover
      target:
        entity_id: all
    - service: climate.set_temperature
      target:
        entity_id: all
      data:
        temperature: 17
  mode: single

# ============================================================================
#  5. BATHROOM
# ============================================================================

- id: "bathroom_light_on"
  alias: "Bad - Licht an (Dual Sensor)"
  description: "Turns on bathroom light if Tuya Presence OR Motion Sensor detects activity."
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.human_presence_detector_bewegung
        - binary_sensor.motion_sensor_bad_bewegung
      to: "on"
    # Trigger on startup if presence is detected
    - platform: homeassistant
      event: start
  condition:
    # Check if presence is active (ignore motion for startup check as it's transient)
    - condition: or
      conditions:
        - condition: state
          entity_id: binary_sensor.human_presence_detector_bewegung
          state: "on"
        - condition: state
          entity_id: binary_sensor.motion_sensor_bad_bewegung
          state: "on"
  action:
    - service: light.turn_on
      target:
        entity_id: light.bad_2
      data:
        brightness_pct: "{{ 10 if now().hour >= 22 or now().hour < 6 else 100 }}"
        color_temp_kelvin: 2700
  mode: single

- id: "bathroom_light_off"
  alias: "Bad - Licht aus"
  description: "Turns off light only when BOTH sensors are clear for 120s."
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.human_presence_detector_bewegung
        - binary_sensor.motion_sensor_bad_bewegung
      to: "off"
      for:
        seconds: 120
  condition:
    - condition: state
      entity_id: binary_sensor.human_presence_detector_bewegung
      state: "off"
    - condition: state
      entity_id: binary_sensor.motion_sensor_bad_bewegung
      state: "off"
  action:
    - service: light.turn_off
      target:
        entity_id: light.bad_2
  mode: single

# ============================================================================
#  6. CLIMATE & SHUTTERS (GENERAL)
# ============================================================================

- id: "climate_heating_home"
  alias: "Klima - Heizen bei Anwesenheit"
  description: "Sets comfortable temperature when you are home."
  trigger:
    - platform: state
      entity_id: person.reid15
      to: "home"
  condition:
    # Heating season check
    - condition: template
      value_template: "{{ now().month in [1, 2, 3, 4, 10, 11, 12] }}"
  action:
    - service: climate.set_temperature
      target:
        entity_id:
          - climate.thermostat_bad
          - climate.thermostat_computer
      data:
        temperature: 22
  mode: single

- id: "shutters_sunset_close"
  alias: "RolllÃ¤den - SchlieÃŸen bei Sonnenuntergang"
  description: "Closes all shutters at sunset (with seasonal delays)."
  trigger:
    - platform: sun
      event: sunset
  action:
    # Seasonal delay logic
    - choose:
        - conditions: "{{ now().month in [5, 6, 7, 8, 9] }}" # Summer
          sequence:
            - delay: "02:00:00"
        - conditions: "{{ now().month in [3, 4, 10] }}" # Spring/Autumn
          sequence:
            - delay: "01:00:00"
    - service: cover.close_cover
      target:
        entity_id: all
  mode: single

# ============================================================================
#  7. CEILING FAN (LIVING ROOM)
# ============================================================================

- id: "fan_winter_heat_distribution"
  alias: "Ventilator - Winter WÃ¤rmeverteilung (Saugmodus)"
  description: "Distributes heat evenly in winter using reverse direction (updraft) at low speed."
  trigger:
    - platform: state
      entity_id: climate.thermostat_computer
      attribute: hvac_action
      to: "heating"
    - platform: state
      entity_id:
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1 # Computer
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_2 # Couch
      to: "on"
  condition:
    # Winter/Autumn Months (Oct-Mar)
    - condition: template
      value_template: "{{ now().month in [10, 11, 12, 1, 2, 3] }}"
    # Someone must be in the room
    - condition: or
      conditions:
        - condition: state
          entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1
          state: "on"
        - condition: state
          entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_2
          state: "on"
  action:
    - service: fan.turn_on
      target:
        entity_id: fan.ceiling_fan_with_light
      data:
        percentage: 33 # Low speed to avoid draft
        direction: "reverse" # Sucking direction (updraft) to mix warm air

- id: "fan_summer_cooling"
  alias: "Ventilator - Sommer KÃ¼hlung (Blasmodus)"
  description: "Provides cooling breeze in summer using forward direction (downdraft)."
  trigger:
    - platform: numeric_state
      entity_id: sensor.temperature_and_humidity_sensor_temperatur # Living Room Temp
      above: 24
    - platform: state
      entity_id:
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_2
      to: "on"
  condition:
    # Summer/Spring Months (Apr-Sep)
    - condition: template
      value_template: "{{ now().month in [4, 5, 6, 7, 8, 9] }}"
    # Room must be warm (>24Â°C)
    - condition: numeric_state
      entity_id: sensor.temperature_and_humidity_sensor_temperatur
      above: 24
    # Someone must be in the room
    - condition: or
      conditions:
        - condition: state
          entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1
          state: "on"
        - condition: state
          entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_2
          state: "on"
  action:
    - service: fan.turn_on
      target:
        entity_id: fan.ceiling_fan_with_light
      data:
        # Higher speed for cooling effect
        percentage: "{{ 66 if states('sensor.temperature_and_humidity_sensor_temperatur')|float < 26 else 100 }}"
        direction: "forward" # Blowing direction (downdraft)

- id: "fan_auto_off"
  alias: "Ventilator - Auto Aus bei Abwesenheit"
  description: "Turns off fan when nobody is in the living room."
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_2
      to: "off"
      for:
        minutes: 5
  condition:
    # Ensure both zones are empty
    - condition: state
      entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1
      state: "off"
    - condition: state
      entity_id: binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_2
      state: "off"
  action:
    - service: fan.turn_off
      target:
        entity_id: fan.ceiling_fan_with_light

# ============================================================================
#  8. CEILING FAN (BEDROOM)
# ============================================================================

- id: "fan_bedroom_winter_heat_distribution"
  alias: "Schlafzimmer Ventilator - Winter WÃ¤rmeverteilung"
  description: "Distributes heat in bedroom during winter (reverse, low speed)."
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_schlafen_bewegung
      to: "on"
  condition:
    - condition: template
      value_template: "{{ now().month in [10, 11, 12, 1, 2, 3] }}"
  action:
    - service: fan.turn_on
      target:
        entity_id: fan.dc_fan_lamp
      data:
        percentage: 33
        direction: "reverse"

- id: "fan_bedroom_summer_cooling"
  alias: "Schlafzimmer Ventilator - Sommer KÃ¼hlung"
  description: "Cooling breeze in bedroom during summer."
  trigger:
    - platform: numeric_state
      entity_id: sensor.motion_sensor_schlafen_temperatur
      above: 23
    - platform: state
      entity_id: binary_sensor.motion_sensor_schlafen_bewegung
      to: "on"
  condition:
    - condition: template
      value_template: "{{ now().month in [4, 5, 6, 7, 8, 9] }}"
    - condition: numeric_state
      entity_id: sensor.motion_sensor_schlafen_temperatur
      above: 23
    - condition: state
      entity_id: binary_sensor.motion_sensor_schlafen_bewegung
      state: "on"
  action:
    - service: fan.turn_on
      target:
        entity_id: fan.dc_fan_lamp
      data:
        percentage: "{{ 66 if states('sensor.motion_sensor_schlafen_temperatur')|float < 25 else 100 }}"
        direction: "forward"

- id: "fan_bedroom_auto_off"
  alias: "Schlafzimmer Ventilator - Auto Aus"
  description: "Turns off bedroom fan when room is empty."
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_schlafen_bewegung
      to: "off"
      for:
        minutes: 5
  action:
    - service: fan.turn_off
      target:
        entity_id: fan.dc_fan_lamp

# ============================================================================
#  9. SYSTEM & MAINTENANCE
# ============================================================================

- id: "system_roborock_clean"
  alias: "System - Roborock Reinigung"
  description: "Starts vacuum at 12:00 on workdays if nobody is home."
  trigger:
    - platform: time
      at: "12:00:00"
  condition:
    - condition: time
      weekday: [mon, tue, wed, thu, fri]
    - condition: state
      entity_id: person.reid15
      state: "not_home"
  action:
    - service: vacuum.start
      target:
        entity_id: vacuum.roborock_q7_max
  mode: single

# ============================================================================
# REID'S HOME ASSISTANT AUTOMATIONS
# Generated based on preferences - 2026-01-08
# ============================================================================

# ============================================================================
# MORNING ROUTINES
# ============================================================================

- id: "morning_wakeup_weekday"
  alias: "Morgen - Aufwachen Werktag (05:00)"
  description: "Gradual wake-up light and heating on weekdays"
  trigger:
    - platform: time
      at: "04:30"
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
  action:
    # Start heating 30 min before wake up
    - action: climate.set_temperature
      target:
        entity_id:
          - climate.thermostat_bad
          - climate.thermostat_computer
      data:
        temperature: 23
    # Wait until actual wake up time for gradual light
    - delay:
        minutes: 30
    # Gradual wake-up light in bedroom (30 min duration)
    - action: light.turn_on
      target:
        entity_id: light.bett_licht
      data:
        brightness_pct: 5
        color_temp_kelvin: 2700
        transition: 1800 # 30 minutes gradual
    # Open bedroom shutters at wake time
    - delay:
        minutes: 30
    - action: light.turn_on
      target:
        entity_id: light.bett_licht
      data:
        brightness_pct: 80
  mode: single

- id: "morning_wakeup_weekend"
  alias: "Morgen - Aufwachen Wochenende (10:00)"
  description: "Weekend wake-up routine"
  trigger:
    - platform: time
      at: "09:30"
  condition:
    - condition: time
      weekday:
        - sat
        - sun
  action:
    # Gradual light starting 30 min before
    - action: light.turn_on
      target:
        entity_id: light.bett_licht
      data:
        brightness_pct: 5
        color_temp_kelvin: 2700
        transition: 1800
  mode: single

# ============================================================================
# ROLLER SHUTTER AUTOMATIONS
# ============================================================================

# ============================================================================
# SEASONAL BLIND OPENING (Smart Energy Saving)
# ============================================================================

- id: "shutters_open_winter_weekend"
  alias: "Rollläden - Öffnen Winter Wochenende"
  description: "Open blinds on winter weekends for solar gain (free heating)"
  trigger:
    - platform: sun
      event: sunrise
      offset: "01:00:00" # Wait 1h after sunrise for sun to warm up
  condition:
    # Only in winter months (Nov-Feb)
    - condition: template
      value_template: "{{ now().month in [11, 12, 1, 2] }}"
    # Only on weekends (you're home)
    - condition: time
      weekday:
        - sat
        - sun
  action:
    # Open all blinds to capture solar heat
    - action: script.safe_open_blind
      data:
        cover_entity: cover.rollladen_computer_vorhang
        tracker_entity: input_boolean.blind_computer_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.schlafen_blind_vorhang
        tracker_entity: input_boolean.blind_schlafen_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.kuche_blind_vorhang
        tracker_entity: input_boolean.blind_kuche_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.yoga_blind_vorhang
        tracker_entity: input_boolean.blind_yoga_last_opened
  mode: single

- id: "shutters_open_winter_weekday_morning_home"
  alias: "Rollläden - Öffnen Winter Werktag Morgen (Zuhause)"
  description: "Open blinds in winter weekday morning if you're home (sick day, home office, etc.)"
  trigger:
    - platform: sun
      event: sunrise
      offset: "01:00:00" # 1h after sunrise
  condition:
    # Only in winter months
    - condition: template
      value_template: "{{ now().month in [11, 12, 1, 2] }}"
    # Only on weekdays
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
    # Only if you're HOME (sick day, home office, vacation)
    - condition: state
      entity_id: person.jonas_glawion
      state: "home"
  action:
    # Open blinds for comfort and solar heating
    - action: script.safe_open_blind
      data:
        cover_entity: cover.rollladen_computer_vorhang
        tracker_entity: input_boolean.blind_computer_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.schlafen_blind_vorhang
        tracker_entity: input_boolean.blind_schlafen_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.kuche_blind_vorhang
        tracker_entity: input_boolean.blind_kuche_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.yoga_blind_vorhang
        tracker_entity: input_boolean.blind_yoga_last_opened
  mode: single

- id: "shutters_open_winter_weekday_afternoon"
  alias: "Rollläden - Öffnen Winter Werktag Nachmittag (Unterwegs)"
  description: "Open blinds on winter weekdays at noon if you're away at work (solar gain)"
  trigger:
    - platform: time
      at: "12:00:00" # Noon - sun is strongest, helps heating
  condition:
    # Only in winter months
    - condition: template
      value_template: "{{ now().month in [11, 12, 1, 2] }}"
    # Only on weekdays
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
    # Only if you're AWAY at work (not home)
    - condition: state
      entity_id: person.jonas_glawion
      state: "not_home"
    # Only if sun is shining (otherwise keep closed)
    - condition: sun
      after: sunrise
      before: sunset
  action:
    # Open blinds for solar heat gain
    - action: script.safe_open_blind
      data:
        cover_entity: cover.rollladen_computer_vorhang
        tracker_entity: input_boolean.blind_computer_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.schlafen_blind_vorhang
        tracker_entity: input_boolean.blind_schlafen_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.kuche_blind_vorhang
        tracker_entity: input_boolean.blind_kuche_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.yoga_blind_vorhang
        tracker_entity: input_boolean.blind_yoga_last_opened
  mode: single

- id: "shutters_open_spring_fall"
  alias: "Rollläden - Öffnen Frühling/Herbst"
  description: "Open blinds at sunrise in spring/fall"
  trigger:
    - platform: sun
      event: sunrise
      offset: "00:30:00" # 30 min after sunrise
  condition:
    # Spring and fall months
    - condition: template
      value_template: "{{ now().month in [3, 4, 5, 9, 10] }}"
    # Only if awake (5am weekdays, 10am weekends)
    - condition: or
      conditions:
        - condition: time
          after: "05:00"
          weekday: [mon, tue, wed, thu, fri]
        - condition: time
          after: "10:00"
          weekday: [sat, sun]
  action:
    - action: script.safe_open_blind
      data:
        cover_entity: cover.rollladen_computer_vorhang
        tracker_entity: input_boolean.blind_computer_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.schlafen_blind_vorhang
        tracker_entity: input_boolean.blind_schlafen_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.kuche_blind_vorhang
        tracker_entity: input_boolean.blind_kuche_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.yoga_blind_vorhang
        tracker_entity: input_boolean.blind_yoga_last_opened
  mode: single

- id: "shutters_open_summer"
  alias: "Rollläden - Öffnen Sommer"
  description: "Open blinds early in summer (but not too early)"
  trigger:
    - platform: sun
      event: sunrise
      offset: "00:00:00"
  condition:
    # Summer months
    - condition: template
      value_template: "{{ now().month in [6, 7, 8] }}"
    # Not before 6am even in summer
    - condition: time
      after: "06:00"
  action:
    - action: script.safe_open_blind
      data:
        cover_entity: cover.rollladen_computer_vorhang
        tracker_entity: input_boolean.blind_computer_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.schlafen_blind_vorhang
        tracker_entity: input_boolean.blind_schlafen_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.kuche_blind_vorhang
        tracker_entity: input_boolean.blind_kuche_last_opened
    - action: script.safe_open_blind
      data:
        cover_entity: cover.yoga_blind_vorhang
        tracker_entity: input_boolean.blind_yoga_last_opened
  mode: single

- id: "shutters_close_sunset_winter"
  alias: "Rollläden - Schließen bei Sonnenuntergang (Winter)"
  description: "Close shutters at sunset in winter (Nov-Feb, no delay)"
  trigger:
    - platform: sun
      event: sunset
      offset: "00:00:00"
  condition:
    - condition: template
      value_template: "{{ now().month in [11, 12, 1, 2] }}"
  action:
    - action: script.all_covers_close
  mode: single

- id: "shutters_close_sunset_spring"
  alias: "Rollläden - Schließen bei Sonnenuntergang (Frühling)"
  description: "Close shutters at sunset +1h in spring (Mar-Apr, Oct)"
  trigger:
    - platform: sun
      event: sunset
      offset: "01:00:00"
  condition:
    - condition: template
      value_template: "{{ now().month in [3, 4, 10] }}"
  action:
    - action: script.all_covers_close
  mode: single

- id: "shutters_close_sunset_summer"
  alias: "Rollläden - Schließen bei Sonnenuntergang (Sommer)"
  description: "Close shutters at sunset +2h in summer (May-Sep)"
  trigger:
    - platform: sun
      event: sunset
      offset: "02:00:00"
  condition:
    - condition: template
      value_template: "{{ now().month in [5, 6, 7, 8, 9] }}"
  action:
    - action: script.all_covers_close
  mode: single

- id: "bedroom_shutters_sleep"
  alias: "Schlafzimmer - Rollläden schließen bei Schlaf"
  description: "Close bedroom shutters when going to bed (motion in bedroom)"
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_schlafen_bewegung
      to: "on"
      for:
        minutes: 15
  condition:
    - condition: time
      after: "22:00"
      before: "08:00"
    # Only if no one else detected elsewhere (sleep mode)
    - condition: state
      entity_id: binary_sensor.human_presence_detector_bewegung
      state: "off"
    - condition: state
      entity_id: binary_sensor.motion_sensor_kuche_bewegung
      state: "off"
  action:
    - action: script.safe_close_blind
      data:
        cover_entity: cover.schlafen_blind_vorhang
        tracker_entity: input_boolean.blind_schlafen_last_opened
  mode: single

# ============================================================================
# MOTION-BASED LIGHTING
# ============================================================================

- id: "light_wohnzimmer_presence"
  alias: "Wohnzimmer - Licht bei Bewegung"
  description: "Turn on living room lights when motion detected"
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.human_presence_detector_bewegung
        - binary_sensor.human_presence_detector_2_bewegung
      to: "on"
  condition:
    # Only when dark (sun below horizon)
    - condition: sun
      after: sunset
      before: sunrise
  action:
    - action: light.turn_on
      target:
        entity_id:
          - light.computer_licht_2
          - light.buffet_licht
      data:
        brightness_pct: "{{ 60 if now().hour >= 22 or now().hour < 6 else 80 }}"
        color_temp_kelvin: 2700
  mode: single

- id: "light_wohnzimmer_off_no_presence"
  alias: "Wohnzimmer - Licht aus ohne Bewegung"
  description: "Turn off living room lights after 120s no motion"
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.human_presence_detector_bewegung
        - binary_sensor.human_presence_detector_2_bewegung
      to: "off"
      for:
        seconds: 120
  condition:
    # All living room motion sensors must be off
    - condition: state
      entity_id: binary_sensor.human_presence_detector_bewegung
      state: "off"
    - condition: state
      entity_id: binary_sensor.human_presence_detector_2_bewegung
      state: "off"
  action:
    - action: light.turn_off
      target:
        entity_id:
          - light.computer_licht_2
          - light.buffet_licht
  mode: single

# ============================================================================
# HEATING AUTOMATIONS
# ============================================================================

- id: "heating_presence_on"
  alias: "Heizung - Komfort bei Anwesenheit"
  description: "Set heating to comfort when home"
  trigger:
    - platform: state
      entity_id: person.jonas_glawion
      to: "home"
  condition:
    # Only in heating season (Oct-Apr)
    - condition: template
      value_template: "{{ now().month in [1, 2, 3, 4, 10, 11, 12] }}"
  action:
    - action: climate.set_temperature
      target:
        entity_id:
          - climate.thermostat_bad
          - climate.thermostat_computer
      data:
        temperature: "{{ 23 if now().month in [11, 12, 1, 2] else 22 }}"
  mode: single

- id: "heating_away_eco"
  alias: "Heizung - Eco bei Abwesenheit"
  description: "Set heating to eco when away"
  trigger:
    - platform: state
      entity_id: person.jonas_glawion
      to: "not_home"
      for:
        minutes: 10
  action:
    - action: climate.set_temperature
      target:
        entity_id:
          - climate.thermostat_bad
          - climate.thermostat_computer
      data:
        temperature: 18
  mode: single

- id: "heating_night_mode"
  alias: "Heizung - Nachtmodus"
  description: "Reduce heating at night"
  trigger:
    - platform: time
      at: "22:00"
  condition:
    - condition: template
      value_template: "{{ now().month in [1, 2, 3, 4, 10, 11, 12] }}"
  action:
    - action: climate.set_temperature
      target:
        entity_id:
          - climate.thermostat_bad
          - climate.thermostat_computer
      data:
        temperature: 17
  mode: single

- id: "heating_morning_restore"
  alias: "Heizung - Morgen Komfort wiederherstellen"
  description: "Restore comfort heating in the morning if you're home"
  trigger:
    # Weekday morning
    - platform: time
      at: "06:00"
      id: weekday
    # Weekend morning (sleep in)
    - platform: time
      at: "09:00"
      id: weekend
  condition:
    # Only in heating season
    - condition: template
      value_template: "{{ now().month in [1, 2, 3, 4, 10, 11, 12] }}"
    # Only if you're HOME
    - condition: state
      entity_id: person.jonas_glawion
      state: "home"
    # Check weekday/weekend match
    - condition: or
      conditions:
        # Weekday trigger on weekday
        - condition: and
          conditions:
            - condition: trigger
              id: weekday
            - condition: time
              weekday: [mon, tue, wed, thu, fri]
        # Weekend trigger on weekend
        - condition: and
          conditions:
            - condition: trigger
              id: weekend
            - condition: time
              weekday: [sat, sun]
  action:
    - action: climate.set_temperature
      target:
        entity_id:
          - climate.thermostat_bad
          - climate.thermostat_computer
      data:
        temperature: "{{ 23 if now().month in [11, 12, 1, 2] else 22 }}"
  mode: single

# ============================================================================
# AWAY MODE & ROBOROCK
# ============================================================================

- id: "roborock_clean_workday"
  alias: "Roborock - Reinigung an Werktagen (12:00)"
  description: "Start vacuum when away on workdays at 12:00"
  trigger:
    - platform: time
      at: "12:00:00"
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
    - condition: state
      entity_id: person.jonas_glawion
      state: "not_home"
  action:
    - action: vacuum.start
      target:
        entity_id: vacuum.roborock_q7_max
  mode: single

- id: "roborock_stop_on_arrival"
  alias: "Roborock - Stopp bei Heimkehr"
  description: "Stop vacuum and return to dock when arriving home"
  trigger:
    - platform: state
      entity_id: person.jonas_glawion
      to: "home"
  condition:
    - condition: state
      entity_id: binary_sensor.roborock_q7_max_reinigen
      state: "on" # 'on' means cleaning for this binary sensor
  action:
    - action: vacuum.return_to_base
      target:
        entity_id: vacuum.roborock_q7_max
  mode: single

# ============================================================================
# WELCOME HOME
# ============================================================================

- id: "welcome_home"
  alias: "Willkommen - Licht an bei Heimkehr"
  description: "Turn on lights when arriving home"
  trigger:
    - platform: state
      entity_id: person.jonas_glawion
      to: "home"
  condition:
    # Only when dark
    - condition: sun
      after: sunset
      before: sunrise
  action:
    - action: light.turn_on
      target:
        entity_id:
          - light.computer_licht
          - light.buffet_lichtstreifen
      data:
        brightness_pct: 80
        color_temp_kelvin: 2700
    # Boost heating in winter
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ now().month in [11, 12, 1, 2] }}"
          sequence:
            - action: climate.set_temperature
              target:
                entity_id:
                  - climate.thermostat_bad
                  - climate.thermostat_computer
              data:
                temperature: 23
  mode: single

# ============================================================================
# AWAY MODE
# ============================================================================

- id: "away_mode_activate"
  alias: "Abwesenheit - Alles aus"
  description: "Turn off lights and reduce heating when leaving"
  trigger:
    - platform: state
      entity_id: person.jonas_glawion
      to: "not_home"
      for:
        minutes: 10
  action:
    - action: light.turn_off
      target:
        entity_id: all
    - action: climate.set_temperature
      target:
        entity_id:
          - climate.thermostat_bad
          - climate.thermostat_computer
      data:
        temperature: 18
  mode: single

# ============================================================================
# SLEEP MODE
# ============================================================================

- id: "sleep_mode"
  alias: "Schlafmodus - Aktivieren"
  description: "Sleep mode when in bedroom for 15 min at night"
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_schlafen_bewegung
      to: "on"
      for:
        minutes: 15
  condition:
    - condition: time
      after: "22:00"
      before: "08:00"
    # No one in other zones (no motion in living room or kitchen)
    - condition: state
      entity_id: binary_sensor.human_presence_detector_bewegung
      state: "off"
    - condition: state
      entity_id: binary_sensor.human_presence_detector_2_bewegung
      state: "off"
    - condition: state
      entity_id: binary_sensor.motion_sensor_kuche_bewegung
      state: "off"
  action:
    # Turn off all lights
    - action: light.turn_off
      target:
        entity_id: all
    # Night temperature
    - action: climate.set_temperature
      target:
        entity_id:
          - climate.thermostat_bad
          - climate.thermostat_computer
      data:
        temperature: 17
    # Close all shutters
    - action: script.all_covers_close
  mode: single

# ============================================================================
# MOVIE MODE
# ============================================================================

- id: "movie_mode"
  alias: "Filmzeit - Aktivieren"
  description: "Movie mode - dim lights, close shutters, ambient on"
  trigger:
    - platform: state
      entity_id: input_boolean.movie_mode
      to: "on"
  action:
    # Dim main lights
    - action: light.turn_off
      target:
        entity_id: light.kuche_brine_1
    - action: light.turn_off
      target:
        entity_id: light.kuche_birne_2_2
    # Ambient lights on low
    - action: light.turn_on
      target:
        entity_id: light.buffet_licht
      data:
        brightness_pct: 20
        color_temp_kelvin: 2200
    # Dim computer light
    - action: light.turn_on
      target:
        entity_id: light.computer_licht_2
      data:
        brightness_pct: 10
        color_temp_kelvin: 2200
    # Close shutters in living room
    - action: script.safe_close_blind
      data:
        cover_entity: cover.rollladen_computer_vorhang
        tracker_entity: input_boolean.blind_computer_last_opened
  mode: single

- id: "movie_mode_off"
  alias: "Filmzeit - Deaktivieren"
  description: "End movie mode"
  trigger:
    - platform: state
      entity_id: input_boolean.movie_mode
      to: "off"
  action:
    - action: light.turn_on
      target:
        entity_id:
          - light.computer_licht_2
          - light.buffet_licht
      data:
        brightness_pct: 60
        color_temp_kelvin: 2700
  mode: single

# ============================================================================
# GUEST MODE
# ============================================================================

- id: "guest_mode_on"
  alias: "Gästemodus - Längere Timeouts"
  description: "Disable automatic shutters and keep lights on longer when guests"
  # This is controlled manually via input_boolean.guest_mode
  trigger:
    - platform: state
      entity_id: input_boolean.guest_mode
      to: "on"
  action:
    - action: automation.turn_off
      target:
        entity_id: automation.rollladen_schliessen_bei_sonnenuntergang_winter
  mode: single

# ============================================================================
# SUN PROTECTION
# ============================================================================

- id: "sun_protection"
  alias: "Sonnenschutz - Rollläden bei Hitze"
  description: "Close shutters when too hot"
  trigger:
    - platform: numeric_state
      entity_id: sensor.openweathermap_temperature
      above: 25
  condition:
    - condition: sun
      after: sunrise
      before: sunset
  action:
    - action: script.all_covers_close
  mode: single

# ============================================================================
# VACATION MODE
# ============================================================================

- id: "vacation_presence_simulation"
  alias: "Urlaub - Anwesenheitssimulation"
  description: "Simulate presence when on vacation"
  trigger:
    - platform: state
      entity_id: input_boolean.vacation_mode
      to: "on"
  action:
    - repeat:
        while:
          - condition: state
            entity_id: input_boolean.vacation_mode
            state: "on"
        sequence:
          # Random light on
          - action: light.turn_on
            target:
              entity_id: "{{ ['light.computer_licht_2', 'light.buffet_licht', 'light.kuche_brine_1'] | random }}"
            data:
              brightness_pct: "{{ range(50, 100) | random }}"
          - delay:
              minutes: "{{ range(30, 120) | random }}"
          # Random light off
          - action: light.turn_off
            target:
              entity_id: "{{ ['light.computer_licht_2', 'light.buffet_licht', 'light.kuche_brine_1'] | random }}"
          - delay:
              minutes: "{{ range(15, 60) | random }}"
  mode: single

# ============================================================================
# SECURITY ALERTS
# ============================================================================

- id: "security_motion_alert"
  alias: "Sicherheit - Bewegung bei Abwesenheit"
  description: "Alert when motion detected while away"
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.human_presence_detector_bewegung
        - binary_sensor.human_presence_detector_2_bewegung
        - binary_sensor.motion_sensor_kuche_bewegung
        - binary_sensor.motion_sensor_schlafen_bewegung
      to: "on"
  condition:
    - condition: state
      entity_id: person.reid15
      state: "not_home"
      for:
        minutes: 30
  action:
    - action: notify.mobile_app_redmi_note_12_pro_5g
      data:
        title: "⚠️ Bewegung erkannt!"
        message: "Bewegung in deiner Wohnung während Abwesenheit"
  mode: single

- id: "security_door_alert"
  alias: "Sicherheit - Tür geöffnet bei Abwesenheit"
  description: "Alert when door opens while away"
  trigger:
    - platform: state
      entity_id: binary_sensor.contact_sensor
      to: "on"
  condition:
    - condition: state
      entity_id: person.reid15
      state: "not_home"
  action:
    - action: notify.mobile_app_redmi_note_12_pro_5g
      data:
        title: "🚪 Tür geöffnet!"
        message: "Die Tür wurde geöffnet während du nicht zuhause bist"
  mode: single

# ============================================================================
# CANNABIS TENT AUTOMATIONS
# ============================================================================

- id: "cannabis_tent_fan_on"
  alias: "Cannabis Zelt - Lüfter AN (High Temp/Humidity)"
  description: "Turn on exhaust fan when humidity > 55% or temp > 26°C (Strawberry Lemonade Flowering)"
  trigger:
    # Humidity Trigger (Early Bloom Target: 40-50%)
    - platform: numeric_state
      entity_id: sensor.temperature_humidity_sensor_luftfeuchtigkeit
      above: 50
    # Temperature Trigger (Target: 21-26°C)
    - type: temperature
      device_id: 489c7522969073f4aebaf5f0a180e34d
      entity_id: sensor.temperature_humidity_sensor_2_temperature
      domain: sensor
      trigger: device
      above: 26
  action:
    - type: turn_on
      device_id: 59f76e362f5e4362255fbc7a3e14661f
      entity_id: c0d7c1a96441be922517ad7e01a9034c
      domain: switch
  mode: single

- id: "cannabis_tent_fan_off"
  alias: "Cannabis Zelt - Lüfter AUS (Optimal)"
  description: "Turn off exhaust fan when humidity < 45% AND temp < 24°C"
  trigger:
    - platform: numeric_state
      entity_id: sensor.temperature_humidity_sensor_luftfeuchtigkeit
      below: 45
  condition:
    # Only turn off if temperature is also safe
    - condition: device
      type: is_temperature
      device_id: 489c7522969073f4aebaf5f0a180e34d
      entity_id: sensor.temperature_humidity_sensor_2_temperature
      domain: sensor
      below: 24
  action:
    - type: turn_off
      device_id: 59f76e362f5e4362255fbc7a3e14661f
      entity_id: c0d7c1a96441be922517ad7e01a9034c
      domain: switch
  mode: single

- id: "cannabis_tent_heater_on"
  alias: "Cannabis Zelt - Heizung AN (Zu kalt)"
  description: "Turn on heater when temp < 19°C (Strawberry Lemonade)"
  trigger:
    - type: temperature
      device_id: 489c7522969073f4aebaf5f0a180e34d
      entity_id: sensor.temperature_humidity_sensor_2_temperature
      domain: sensor
      trigger: device
      below: 20
  action:
    - type: turn_on
      device_id: 89d49889a0136d06079eed05c4897a1b
      entity_id: 1ece694928c3d8f3f6e38006f40c7a33
      domain: switch
  mode: single

- id: "cannabis_tent_heater_off_target"
  alias: "Cannabis Zelt - Heizung AUS (Ziel erreicht)"
  description: "Turn off heater when temp > 24°C"
  trigger:
    - type: temperature
      device_id: 489c7522969073f4aebaf5f0a180e34d
      entity_id: sensor.temperature_humidity_sensor_2_temperature
      domain: sensor
      trigger: device
      above: 25
  action:
    - type: turn_off
      device_id: 89d49889a0136d06079eed05c4897a1b
      entity_id: 1ece694928c3d8f3f6e38006f40c7a33
      domain: switch
  mode: single

- id: "cannabis_tent_heater_safety"
  alias: "Cannabis Zelt - Heizung NOT-AUS (5 min Limit)"
  description: "Safety: Turn off heater after 5 minutes to prevent overheating"
  trigger:
    - platform: device
      type: turned_on
      device_id: 89d49889a0136d06079eed05c4897a1b
      entity_id: 1ece694928c3d8f3f6e38006f40c7a33
      domain: switch
      for:
        minutes: 5
  action:
    - type: turn_off
      device_id: 89d49889a0136d06079eed05c4897a1b
      entity_id: 1ece694928c3d8f3f6e38006f40c7a33
      domain: switch
  mode: single

- id: "system_auto_update_away"
  alias: "System - Automatische Updates bei Abwesenheit"
  description: "Install updates automatically when away"
  trigger:
    # Trigger when updates become available
    - platform: state
      entity_id:
        - update.home_assistant_core_update
        - update.home_assistant_supervisor_update
        - update.home_assistant_operating_system_update
      to: "on"
    # Trigger when leaving home (in case updates are already pending)
    - platform: state
      entity_id: person.jonas_glawion
      to: "not_home"
  condition:
    # Only if user is away
    - condition: state
      entity_id: person.jonas_glawion
      state: "not_home"
  action:
    # Core Update
    - choose:
        - conditions:
            - condition: state
              entity_id: update.home_assistant_core_update
              state: "on"
          sequence:
            - action: update.install
              target:
                entity_id: update.home_assistant_core_update
              data:
                backup: true
    # Supervisor Update
    - choose:
        - conditions:
            - condition: state
              entity_id: update.home_assistant_supervisor_update
              state: "on"
          sequence:
            - action: update.install
              target:
                entity_id: update.home_assistant_supervisor_update
    # OS Update
    - choose:
        - conditions:
            - condition: state
              entity_id: update.home_assistant_operating_system_update
              state: "on"
          sequence:
            - action: update.install
              target:
                entity_id: update.home_assistant_operating_system_update
              data:
                backup: true
  mode: single

# ============================================================================
# SYSTEM MAINTENANCE
# ============================================================================

- id: "reset_blind_trackers"
  alias: "System - Reset Blind Trackers (04:00)"
  description: "Resets blind state trackers to ensure morning opening works"
  trigger:
    - platform: time
      at: "04:00:00"
  action:
    - action: input_boolean.turn_off
      target:
        entity_id:
          - input_boolean.blind_computer_last_opened
          - input_boolean.blind_schlafen_last_opened
          - input_boolean.blind_kuche_last_opened
          - input_boolean.blind_yoga_last_opened
  mode: single

- id: "deckenventilator_wintermode"
  alias: "Deckenventilator - Wintermodus (Heizung an)"
  description: "Turn on fan when heating is on to distribute heat"
  mode: single
  trigger:
    - platform: state
      entity_id: climate.thermostat_computer
      to: "heat"
      for:
        minutes: 5
  action:
    - action: script.fan_winter_heat_now

# ============================================================================
# BATHROOM LIGHT AUTOMATIONS
# ============================================================================
- id: "bad_licht_an_bei_prasenz"
  alias: "Bad - Licht an bei Präsenz"
  description: "Turn on bathroom light when presence detected"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.human_presence_detector_bewegung
      to: "on"
  condition:
    - condition: numeric_state
      entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level
      below: 50
  action:
    - action: light.turn_on
      target:
        entity_id:
          - light.bad
          - light.bad_2
      data:
        brightness_pct: 100

- id: "bad_licht_aus_keine_prasenz"
  alias: "Bad - Licht aus ohne Präsenz"
  description: "Turn off bathroom light when no presence for 3 minutes"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.human_presence_detector_bewegung
      to: "off"
  action:
    - action: light.turn_off
      target:
        entity_id:
          - light.bad
          - light.bad_2

# ============================================================================
# BEDROOM LIGHT AUTOMATIONS
# ============================================================================
- id: "schlafzimmer_licht_an_bei_prasenz"
  alias: "Schlafzimmer - Licht an bei Präsenz"
  description: "Turn on bedroom light when presence detected (only when dark)"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.human_presence_detector_2_bewegung
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.dunkel_draussen
      state: "on"
    - condition: state
      entity_id: input_boolean.someone_sleeping
      state: "off"
  action:
    - action: light.turn_on
      target:
        entity_id:
          - light.schlafzimmer_licht
      data:
        brightness_pct: >
          {% set hour = now().hour %}
          {% if hour >= 22 or hour < 6 %}
            20
          {% else %}
            80
          {% endif %}
        color_temp_kelvin: 2700

- id: "schlafzimmer_licht_aus_keine_prasenz"
  alias: "Schlafzimmer - Licht aus ohne Präsenz"
  description: "Turn off bedroom light when no presence for 5 minutes"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.human_presence_detector_2_bewegung
      to: "off"
  action:
    - action: light.turn_off
      target:
        entity_id:
          - light.schlafzimmer_licht

# ============================================================================
# KITCHEN LIGHT AUTOMATIONS
# ============================================================================
- id: "kuche_licht_an_bei_prasenz"
  alias: "Küche - Licht an bei Präsenz"
  description: "Turn on kitchen light when presence detected"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_kuche_bewegung
      to: "on"
  condition:
    - condition: numeric_state
      entity_id: sensor.presence_sensor_fp2_f9cf_light_sensor_light_level
      below: 50
  action:
    - action: light.turn_on
      target:
        entity_id:
          - light.kitchen_furniture
          - light.kuche_streifen
          - light.kuche_birne_1
          - light.kuche_birne_2_2
          - light.kuche_birne_2
          - light.kuche_brine_1
          - light.kuche_blind_hintergrundbeleuchtung
      data:
        brightness_pct: 100

- id: "kuche_licht_aus_keine_prasenz"
  alias: "Küche - Licht aus ohne Bewegung"
  description: "Turn off kitchen light immediately when no presence"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_sensor_kuche_bewegung
      to: "off"
  action:
    - action: light.turn_off
      target:
        entity_id:
          - light.kitchen_furniture
          - light.kuche_streifen
          - light.kuche_birne_1
          - light.kuche_birne_2_2
          - light.kuche_birne_2
          - light.kuche_brine_1
          - light.kuche_blind_hintergrundbeleuchtung
      data:
        transition: 9

# ============================================================================
# SLEEP DETECTION
# ============================================================================
- id: "sleep_detection_on"
  alias: "Schlafmodus - Aktivieren"
  description: "Detect sleep: bedroom presence + no movement for 10 min after 22:00"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.human_presence_detector_2_bewegung
      to: "on"
      for:
        minutes: 10
  condition:
    - condition: time
      after: "22:00:00"
      before: "06:00:00"
  action:
    - action: input_boolean.turn_on
      target:
        entity_id: input_boolean.someone_sleeping
    - action: light.turn_off
      target:
        entity_id: light.schlafzimmer_licht

- id: "sleep_detection_off"
  alias: "Schlafmodus - Deaktivieren"
  description: "Reset sleep mode when activity in living room or kitchen"
  mode: single
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_1
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_2
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_3
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_4
        - binary_sensor.presence_sensor_fp2_f9cf_presence_sensor_5
        - binary_sensor.motion_sensor_kuche_bewegung
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.someone_sleeping
      state: "on"
  action:
    - action: input_boolean.turn_off
      target:
        entity_id: input_boolean.someone_sleeping

# ============================================================================
# AUTOMATION: "Gute Nacht" - Bettgeh-Routine
# ============================================================================
#
# ZWECK: Alle Aktionen beim Schlafengehen mit einem Knopf
#
# WAS PASSIERT:
# - Alle Lichter ausschalten (mit kurzer Nachtlicht-Phase)
# - Alle Rolll√§den runterfahren
# - Heizung auf Schlaf-Temperatur
# - Fenster/T√ºr-Check mit Warnung
# - Optional: Smart Plugs ausschalten (PC, etc.)
#
# ANPASSUNGEN ERFORDERLICH:
# 1. Entity-IDs ersetzen
# 2. Temperaturen anpassen
# 3. Trigger-Methode w√§hlen
#
# SCHWIERIGKEIT: Einfach
# ZEIT: 10 Minuten
#
# ============================================================================

- id: good_night_routine
  alias: "Gute Nacht"
  description: "Schaltet alle Systeme f√ºr die Nacht um"

  # ==========================================================================
  # TRIGGER
  # ==========================================================================

  trigger:
    # OPTION A: Manueller Button (empfohlen)
    - platform: state
      entity_id: input_boolean.good_night_trigger
      to: "on"

    # OPTION B: Zeitbasiert + keine Bewegung
    # - platform: time
    #   at: "23:00:00"
    # - platform: state
    #   entity_id: binary_sensor.presence_sensor_fp2_combined
    #   to: "off"
    #   for: "00:20:00"  # 20 Min keine Bewegung nach 23 Uhr

    # OPTION C: Sprachbefehl (via Alexa Routine)
    # Erstelle Alexa-Routine die input_boolean.good_night_trigger aktiviert

  condition: []

  # ==========================================================================
  # AKTIONEN
  # ==========================================================================

  action:
    # ------------------------------------------------------------------------
    # 1. ALLE ROLLL√ÑDEN RUNTERFAHREN (zuerst, dauert am l√§ngsten)
    # ------------------------------------------------------------------------
    - service: cover.close_cover
      target:
        entity_id:
          # ‚ö†Ô∏è ERSETZE MIT DEINEN ROLLLADEN-ENTITY-IDs
          - cover.rollladen_computer_vorhang
          - cover.kuche_blind_vorhang
          - cover.schlafen_blind_vorhang
          - cover.yoga_blind_vorhang
      continue_on_error: true

    # ------------------------------------------------------------------------
    # 2. HEIZUNG AUF SCHLAF-TEMPERATUR
    # ------------------------------------------------------------------------

    # Schlafzimmer: K√ºhl f√ºr guten Schlaf
    - service: climate.set_temperature
      target:
        entity_id: climate.thermostat_schlafzimmer  # ‚ö†Ô∏è ANPASSEN falls vorhanden
      data:
        temperature: 18  # ‚ö†Ô∏è ANPASSEN: Optimal 16-19¬∞C f√ºr Schlaf
      continue_on_error: true

    # Andere R√§ume: Eco-Modus
    - service: climate.set_temperature
      target:
        entity_id:
          - climate.thermostat_bad
          - climate.thermostat_computer
      data:
        temperature: 16  # ‚ö†Ô∏è ANPASSEN: Eco w√§hrend Nacht
      continue_on_error: true

    # ------------------------------------------------------------------------
    # 3. NACHTLICHT-PHASE (30 Sekunden Orientierung)
    # ------------------------------------------------------------------------

    # Schlafzimmer-Licht auf 5% f√ºr 30 Sekunden
    - service: light.turn_on
      target:
        entity_id: light.schlafzimmer_licht  # ‚ö†Ô∏è ANPASSEN
      data:
        brightness_pct: 5
        color_temp: 500  # Warm-wei√ü (niedrige Kelvin)
      continue_on_error: true

    # Warte 30 Sekunden
    - delay: "00:00:30"

    # ------------------------------------------------------------------------
    # 4. ALLE LICHTER AUSSCHALTEN
    # ------------------------------------------------------------------------
    - service: light.turn_off
      target:
        entity_id:
          # ‚ö†Ô∏è ERSETZE MIT ALLEN DEINEN LICHT-ENTITY-IDs
          - light.bad
          - light.bett_licht
          - light.buffet_lichtstreifen
          - light.computer_licht
          - light.kiffzimmer_lichtstreifen
          - light.kuche_birne_1
          - light.kuche_birne_2
          - light.kuche_streifen
          - light.schlafzimmer_licht
          - light.kleiderschrank
          # F√ºge ALLE deine 28 Lichter hinzu!
      data:
        transition: 3  # Sanftes Ausblenden √ºber 3 Sekunden
      continue_on_error: true

    # ------------------------------------------------------------------------
    # 5. SMART PLUGS AUSSCHALTEN (Optional)
    # ------------------------------------------------------------------------

    # PC ausschalten (falls Smart Plug vorhanden)
    # - service: switch.turn_off
    #   target:
    #     entity_id: switch.pc_plug
    #   continue_on_error: true

    # Gaming-Ger√§te ausschalten
    # - service: switch.turn_off
    #   target:
    #     entity_id:
    #       - switch.monitor_plug
    #       - switch.ps5_plug
    #   continue_on_error: true

    # ------------------------------------------------------------------------
    # 6. FENSTER/T√úR-CHECK ‚Üí WARNUNG
    # ------------------------------------------------------------------------
    - choose:
        - conditions:
            - condition: or
              conditions:
                # ‚ö†Ô∏è ERSETZE MIT DEINEN FENSTER/T√úR-SENSOREN
                - condition: state
                  entity_id: binary_sensor.aqara_door_and_window_sensor_tur
                  state: "on"  # on = offen
                - condition: state
                  entity_id: binary_sensor.aqara_door_and_window_sensor_tur_2
                  state: "on"
          sequence:
            # Alexa-Ansage
            - service: notify.alexa_media_wohnzimmer
              data:
                message: "Achtung: Ein Fenster oder eine T√ºr ist noch offen. M√∂chtest du schlafen gehen?"
                data:
                  type: announce

            # Optional: Handy-Benachrichtigung
            # - service: notify.mobile_app_dein_handy
            #   data:
            #     title: "‚ö†Ô∏è Fenster/T√ºr offen!"
            #     message: "Ein Fenster oder T√ºr ist noch offen vor dem Schlafengehen."
            #     data:
            #       tag: "window_open_night"
            #       actions:
            #         - action: "CLOSE_ALL"
            #           title: "Alle schlie√üen"
            #         - action: "IGNORE"
            #           title: "Ignorieren"

    # ------------------------------------------------------------------------
    # 7. STATUS SETZEN
    # ------------------------------------------------------------------------

    # Night-Mode aktivieren (Helper)
    # - service: input_boolean.turn_on
    #   target:
    #     entity_id: input_boolean.night_mode

    # ------------------------------------------------------------------------
    # 8. LOG-EINTRAG
    # ------------------------------------------------------------------------
    - service: logbook.log
      data:
        name: "Gute Nacht"
        message: "Alle Systeme auf Nacht-Modus gesetzt"

  mode: single

# ============================================================================
# ZUSATZ-AUTOMATION: "Guten Morgen" (Umkehrung)
# ============================================================================

- id: good_morning_routine
  alias: "Guten Morgen"
  description: "Aktiviert Morgen-Einstellungen beim Aufwachen"

  trigger:
    # OPTION A: Wecker klingelt (falls Smart-Home-Integration)
    # - platform: state
    #   entity_id: sensor.next_alarm
    #   # Trigger wenn Wecker klingelt

    # OPTION B: Feste Zeit (Wochentags)
    - platform: time
      at: "06:30:00"

    # OPTION C: Manueller Button
    - platform: state
      entity_id: input_boolean.good_morning_trigger
      to: "on"

  condition:
    # Nur an Werktagen (optional)
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri

  action:
    # Heizung Bad vorheizen (f√ºrs Duschen)
    - service: climate.set_temperature
      target:
        entity_id: climate.thermostat_bad
      data:
        temperature: 22  # ‚ö†Ô∏è ANPASSEN: Warm f√ºrs Duschen
      continue_on_error: true

    # Andere R√§ume: Komfort-Temperatur
    - service: climate.set_temperature
      target:
        entity_id: climate.thermostat_computer
      data:
        temperature: 20
      continue_on_error: true

    # Schlafzimmer-Licht sanft hochdimmen (Lichtwecker-Effekt)
    - service: light.turn_on
      target:
        entity_id: light.schlafzimmer_licht
      data:
        brightness_pct: 1
        color_temp: 400  # Warm
        transition: 0
      continue_on_error: true

    # √úber 15 Minuten langsam auf 50% dimmen
    - repeat:
        count: 15
        sequence:
          - delay: "00:01:00"  # 1 Minute
          - service: light.turn_on
            target:
              entity_id: light.schlafzimmer_licht
            data:
              brightness_pct: "{{ 1 + (repeat.index * 3) }}"  # +3% pro Minute
              transition: 60
            continue_on_error: true

    # Rolll√§den langsam hochfahren (nach Lichtwecker)
    - delay: "00:05:00"  # 5 Min warten
    - service: cover.open_cover
      target:
        entity_id:
          - cover.schlafen_blind_vorhang
          - cover.kuche_blind_vorhang
      continue_on_error: true

    # Night-Mode deaktivieren
    # - service: input_boolean.turn_off
    #   target:
    #     entity_id: input_boolean.night_mode

  mode: single

# ============================================================================
# BEN√ñTIGTE HELPERS
# ============================================================================
#
# Configuration ‚Üí Helpers ‚Üí Create Helper
#
# 1. INPUT BOOLEAN: good_night_trigger
#    - Name: "Gute Nacht Trigger"
#    - Icon: mdi:sleep
#
# 2. INPUT BOOLEAN: good_morning_trigger
#    - Name: "Guten Morgen Trigger"
#    - Icon: mdi:weather-sunny
#
# 3. INPUT BOOLEAN: night_mode (optional)
#    - Name: "Nacht-Modus"
#    - Icon: mdi:moon-waning-crescent
#
# ============================================================================
# DASHBOARD-BUTTON
# ============================================================================
#
# type: button
# entity: input_boolean.good_night_trigger
# name: "üåô Gute Nacht"
# icon: mdi:sleep
# tap_action:
#   action: toggle
# show_state: false
#
# ============================================================================
# ALEXA-INTEGRATION
# ============================================================================
#
# Erstelle Alexa-Routine:
# "Alexa, Gute Nacht"
# ‚Üí Aktiviere input_boolean.good_night_trigger
#
# ============================================================================
